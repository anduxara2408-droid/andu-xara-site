    window.gtag = function() {
        if (window.dataLayer) {
            window.dataLayer.push(arguments);
        }
        console.log('üîß Analytics:', arguments);
    };

    // Mode d√©veloppement - Toujours actif mais s√©curis√©
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        console.log('üîß Mode d√©veloppement - Analytics en mode simulation');
    } else {
        // Mode production - Chargement conditionnel
        const script = document.createElement('script');
        script.async = true;
        script.src = 'https://www.googletagmanager.com/gtag/js?id=G-HMHF43YF7N';
        script.onerror = function() {
            console.log('‚ùå Google Analytics non charg√© - ID potentiellement invalide');
        };
        document.head.appendChild(script);
        
        // Configuration de base
        gtag('js', new Date());
        gtag('config', 'G-HMHF43YF7N', {
            debug_mode: false,
            page_title: document.title,
            page_location: window.location.href
        });
    }

    // ===== FONCTIONS DE TRACKING ANALYTICS S√âCURIS√âES =====
    function trackGAEvent(eventName, parameters) {
        if (typeof gtag === 'function') {
            gtag('event', eventName, parameters);
        }
    }

    function trackPageView(pageTitle, pageLocation) {
        if (typeof gtag === 'function') {
            gtag('event', 'page_view', {
                page_title: pageTitle,
                page_location: pageLocation,
                page_path: window.location.pathname
            });
        }
    }

    function trackAddToCart(productName, category, price) {
        trackGAEvent('add_to_cart', {
            'currency': 'MRU',
            'value': price,
            'items': [{
                'item_name': productName,
                'item_category': category,
                'price': price,
                'quantity': 1
            }]
        });
    }

    function trackProductView(productName, category, price) {
        trackGAEvent('view_item', {
            'currency': 'MRU',
            'value': price,
            'items': [{
                'item_name': productName,
                'item_category': category,
                'price': price
            }]
        });
    }

    function trackPurchase(totalAmount, products) {
        trackGAEvent('purchase', {
            'currency': 'MRU',
            'value': totalAmount,
            'items': products
        });
    }

</script>
</head>
<body>
<script>
// Redirection HTTPS seulement en production (pas sur localhost)
if (window.location.hostname !== 'localhost' && 
    window.location.hostname !== '127.0.0.1' && 
    window.location.protocol === 'http:') {
    window.location.href = 'https://' + window.location.host + window.location.pathname + window.location.search;
}
function initMenuMobile() {
    const toggleBtn = document.querySelector('.menu-toggle');
    const menu = document.querySelector('.mobile-menu');
    const overlay = document.querySelector('.menu-overlay');

    // ‚úÖ CORRECTION : V√©rifier si les √©l√©ments existent AVANT d'ajouter les events
    if (toggleBtn && menu && overlay) {
        toggleBtn.addEventListener('click', () => {
            menu.classList.toggle('active');
            overlay.classList.toggle('active');
            toggleBtn.setAttribute('aria-expanded', menu.classList.contains('active'));
        });

        overlay.addEventListener('click', () => {
            menu.classList.remove('active');
            overlay.classList.remove('active');
            toggleBtn.setAttribute('aria-expanded', 'false');
        });

        // Fermer le menu au clic sur un lien
        menu.querySelectorAll('a').forEach(link => {
            link.addEventListener('click', () => {
                menu.classList.remove('active');
                overlay.classList.remove('active');
                toggleBtn.setAttribute('aria-expanded', 'false');
            });
        });
    }
    // ‚úÖ Si les √©l√©ments n'existent pas, pas d'erreur - silence is golden
}
document.addEventListener('DOMContentLoaded', function() {
    initMenuMobile();
});

        // ===== WISHLIST =====
        function toggleWishlist(productId) {
            const index = wishlistItems.indexOf(productId);
            const button = event.currentTarget;
            
            if (index > -1) {
                wishlistItems.splice(index, 1);
                button.classList.remove('active');
                showNotification('Retir√© des favoris', 'warning');
            } else {
                wishlistItems.push(productId);
                button.classList.add('active');
                showNotification('Ajout√© aux favoris ‚ù§Ô∏è');
            }
            
            localStorage.setItem('wishlistItems', JSON.stringify(wishlistItems));
            updateWishlistCounter();
        }

        function updateWishlistCounter() {
            const counter = document.getElementById('wishlist-counter');
            if (counter) {
                counter.textContent = wishlistItems.length;
            }
        }


        // ===== BADGE SONINK√â =====
        function initSoninkeBadge() {
            const messagesLeft = [
                "Xa k√©√© bir√© waaga Soninko",
                "Bonne f√™te de la langue Sonink√© !",
                "Profitez de votre journ√©e !"
            ];

            let indexLeft = 0;
            const textElLeft = document.getElementById('soninke-text-left');

            setInterval(() => {
                textElLeft.style.opacity = 0;
                setTimeout(() => {
                    indexLeft = (indexLeft + 1) % messagesLeft.length;
                    textElLeft.textContent = messagesLeft[indexLeft];
                    textElLeft.style.opacity = 1;
                }, 500);
            }, 3000);
              } 


        // ===== VARIATIONS PRODUITS =====
        function initVariationButtons() {
            document.querySelectorAll('.variation-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const parent = this.closest('.variation-selector');
                    parent.querySelectorAll('.variation-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    this.classList.add('active');
                });
            });
        }

        function getSelectedSize() {
            const activeSize = document.querySelector('.variation-btn.active[data-size]');
            return activeSize ? activeSize.dataset.size : 'M';
        }

        // ===== RECHERCHE =====
        document.getElementById('search-input').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const products = document.querySelectorAll('.product-card');

            products.forEach(product => {
                const title = product.querySelector('.product-title').textContent.toLowerCase();
                const description = product.querySelector('.product-description').textContent.toLowerCase();

                if (title.includes(searchTerm) || description.includes(searchTerm)) {
                    product.style.display = 'block';
                } else {
                    product.style.display = 'none';
                }
            });
        });

        // ===== CAT√âGORIES =====
        document.querySelectorAll('.category-btn').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('.category-btn').forEach(btn => {
                    btn.classList.remove('active');
                });

                this.classList.add('active');
                const category = this.getAttribute('data-category');
                const products = document.querySelectorAll('.product-card');
                
                products.forEach(product => {
                    if (category === 'tous') {
                        product.style.display = 'block';
                    } else {
                        const productCategory = product.getAttribute('data-category');
                        product.style.display = (productCategory === category) ? 'block' : 'none';
                    }
                });
            });
        });

        // ===== BANNI√àRES CAT√âGORIES =====
        document.querySelectorAll('.category-banner').forEach(banner => {
            banner.addEventListener('click', function() {
                const category = this.getAttribute('data-category');
                document.querySelector(`.category-btn[data-category="${category}"]`).click();
                window.scrollTo({ top: document.querySelector('.products-grid').offsetTop - 100, behavior: 'smooth' });
            });
        });

        // ===== NOTIFICATIONS =====
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = 'notification ' + type;
            notification.innerHTML = `
                <span class="notification-icon">${type === 'success' ? '‚úÖ' : '‚ö†Ô∏è'}</span>
                <span>${message}</span>
            `;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // ===== TOAST =====
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // ===== FILTRES PRODUITS =====
        function filtrerProduits() {
            const categorie = document.getElementById('categorie').value;
            const prixMax = parseInt(document.getElementById('prix').value);
            const produits = document.querySelectorAll('.produit');

            produits.forEach(produit => {
                const produitCategorie = produit.getAttribute('data-categorie');
                const produitPrix = parseInt(produit.getAttribute('data-prix'));

                const matchCategorie = categorie === 'all' || produitCategorie === categorie;
                const matchPrix = produitPrix <= prixMax;

                produit.style.display = (matchCategorie && matchPrix) ? 'block' : 'none';
            });
        }
// ===== SERVICE WORKER PWA =====
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        // Chemin relatif pour fonctionner partout
        navigator.serviceWorker.register('./sw.js')
            .then(registration => console.log('‚úÖ SW enregistr√©:', registration.scope))
            .catch(error => console.log('‚ùå SW √©chec:', error));
    });
}
    function receiveCreditsFromReductions() {
        console.log("üéØ R√©ception des cr√©dits - D√©marrage");
        
        // M√©thode 1: R√©cup√©rer depuis l'URL
        const urlParams = new URLSearchParams(window.location.search);
        const creditsFromUrl = urlParams.get('credits');
        if (creditsFromUrl) {
            const credits = parseInt(creditsFromUrl);
            localStorage.setItem('anduxara_referral_credits', credits.toString());
            console.log("üì• Cr√©dits re√ßus depuis URL:", credits, "MRU");
        }
        
        // M√©thode 2: R√©cup√©rer depuis sessionStorage
        const creditsFromSession = sessionStorage.getItem('anduxara_referral_credits');
        if (creditsFromSession) {
            const credits = parseInt(creditsFromSession);
            localStorage.setItem('anduxara_referral_credits', credits.toString());
            console.log("üì• Cr√©dits re√ßus depuis sessionStorage:", credits, "MRU");
            sessionStorage.removeItem('anduxara_referral_credits');
        }
        
        // M√©thode 3: √âcouter les messages
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'REFERRAL_CREDITS') {
                const credits = event.data.credits;
                localStorage.setItem('anduxara_referral_credits', credits.toString());
                console.log("üì® Cr√©dits re√ßus via postMessage:", credits, "MRU");
                
                // Afficher le badge imm√©diatement
                if (window.createCreditsBadge) {
                    window.createCreditsBadge();
                }
            }
        });
        
        console.log("üéØ R√©ception des cr√©dits - Pr√™t");
    }
    
    // D√©marrer la r√©ception
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', receiveCreditsFromReductions);
    } else {
        receiveCreditsFromReductions();
    }
    </script>
    <!-- Badge cr√©dits -->
    <script src="js/secure/credits-badge-no-icons.js"></script>
<script src="js/secure/fix.js"></script>
<script src="js/secure/promo-enhanced.js"></script>
    
<!-- Panier Integration D√©sactiv√©e -->
<!-- <script src="js/secure/panier-integration-stable.js"></script> -->
    
<script type="module">
    import { getDatabase, ref, set, onDisconnect, onValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

    // Configuration Firebase - utilise ton projet andu-xara-online-counter
    const firebaseConfig = {
        apiKey: "AIzaSyBjzBW5ADllWk2292Xv1C3mlm4X08XyknM",
        authDomain: "andu-xara-online-counter.firebaseapp.com",
        databaseURL: "https://andu-xara-online-counter-default-rtdb.firebaseio.com",
        projectId: "andu-xara-online-counter",
        storageBucket: "andu-xara-online-counter.firebasestorage.app",
        messagingSenderId: "89485701999",
        appId: "1:89485701999:web:0884ea2f5d246570f1ee9a",
        measurementId: "G-0FN2XN1QGG"
    };

    // Initialiser Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
 <!-- Correctif Compteur Utilisateurs -->
    <script src="js/secure/user-counter-fix.js"></script>


<script>

   
 console.log('üöÄ Initialisation du vrai compteur Firebase...');

    // Cr√©er un ID unique pour cet utilisateur
    const userId = 'visitor_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    const userRef = ref(db, 'onlineUsers/' + userId);

    // Fonction pour mettre √† jour l'affichage
    function updateCounterDisplay(count) {
        document.getElementById('visitorCount').textContent = count;
        console.log('üë• Vrais utilisateurs en ligne:', count);
    }

    // SE CONNECTER - cet utilisateur rejoint
    set(userRef, {
        joinedAt: serverTimestamp(),
        lastSeen: Date.now(),
        userAgent: navigator.userAgent.substring(0, 80)
    }).then(() => {
        console.log('‚úÖ Utilisateur connect√©:', userId);
    }).catch(error => {
        console.error('‚ùå Erreur connexion:', error);
    });

    // SE D√âCONNECTER AUTOMATIQUEMENT quand l'onglet se ferme
    onDisconnect(userRef).remove().then(() => {
        console.log('‚úÖ D√©connexion automatique configur√©e');
    });

    // SURVEILLER TOUS LES UTILISATEURS EN TEMPS R√âEL
    const onlineUsersRef = ref(db, 'onlineUsers');
    onValue(onlineUsersRef, (snapshot) => {
        if (snapshot.exists()) {
            const users = snapshot.val();
            const realTimeCount = Object.keys(users).length;
            console.log('üìä Vrai compteur temps r√©el:', realTimeCount, 'utilisateurs');
            updateCounterDisplay(realTimeCount);
            
            // Nettoyer les utilisateurs inactifs (optionnel)
            cleanInactiveUsers(users);
        } else {
            // Personne en ligne
            console.log('üìä Aucun utilisateur en ligne');
            updateCounterDisplay(0);
        }
    });

    // Nettoyer les utilisateurs inactifs (plus de 5 minutes)
    function cleanInactiveUsers(users) {
        const now = Date.now();
        const fiveMinutesAgo = now - 300000; // 5 minutes
        
        for (const [uid, userData] of Object.entries(users)) {
            if (userData.lastSeen && userData.lastSeen < fiveMinutesAgo) {
                // Supprimer l'utilisateur inactif
                const inactiveUserRef = ref(db, 'onlineUsers/' + uid);
                set(inactiveUserRef, null);
                console.log('üßπ Utilisateur inactif nettoy√©:', uid);
            }
        }
    }

    // Maintenir la connexion active AVEC GESTION D'ERREURS
    setInterval(() => {
        try {
    setInterval(() => {
        try {
            set(userRef, {
                lastSeen: Date.now(),
                active: true
            }).catch(error => {
                console.warn("‚ö†Ô∏è Mise √† jour connexion √©chou√©e:", error);
            });
        } catch (error) {
            console.warn("‚ö†Ô∏è Erreur mise √† jour connexion:", error);
        }
    }, 30000);

<script>
// === COMPTE √Ä REBOURS AM√âLIOR√â ===
console.log('üéØ Initialisation compte √† rebours am√©lior√©...');

function initializeCountdown() {
    let endDate;
    const savedDate = localStorage.getItem('promoEndDate');
    const now = new Date().getTime();
    
    // V√©rifier si la date sauvegard√©e est valide et dans le futur
    if (savedDate) {
        const savedTime = parseInt(savedDate);
        endDate = new Date(savedTime);
        
        // Si la date est dans le pass√©, en cr√©er une nouvelle
        if (endDate.getTime() <= now) {
            console.log('üîÑ Date expir√©e, cr√©ation nouvelle date');
            endDate = createEndDate();
            localStorage.setItem('promoEndDate', endDate.getTime());
        } else {
            console.log('üìÖ Date valide trouv√©e:', endDate);
        }
    } else {
        // Cr√©er une nouvelle date
        endDate = createEndDate();
        localStorage.setItem('promoEndDate', endDate.getTime());
        console.log('üÜï Nouvelle date cr√©√©e:', endDate);
    }
    
    return endDate;
}
function createEndDate() {
    const endDate = new Date();
    endDate.setDate(endDate.getDate() + 20);
    endDate.setHours(23, 59, 59, 999);
    return endDate;
}
function startCountdown() {
    const endDate = initializeCountdown();
    const now = new Date().getTime();
    const distance = endDate - now;
    
    console.log('‚è∞ Temps restant:', Math.floor(distance / (1000 * 60 * 60 * 24)) + ' jours');
    
    if (distance <= 0) {
        showPromotionEnded();
        return;
    }

    updateCountdown(endDate);
}
function updateCountdown(endDate) {
    const now = new Date().getTime();
    const distance = endDate - now;

    if (distance <= 0) {
        showPromotionEnded();
        return;
    }

    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((distance % (1000 * 60)) / 1000);

    // Mettre √† jour l'affichage
    document.getElementById('days').textContent = days.toString().padStart(2, '0');
    document.getElementById('hours').textContent = hours.toString().padStart(2, '0');
    document.getElementById('minutes').textContent = minutes.toString().padStart(2, '0');
    document.getElementById('seconds').textContent = seconds.toString().padStart(2, '0');

    setTimeout(() => updateCountdown(endDate), 1000);
}
function showPromotionEnded() {
    const countdownElement = document.querySelector('.promo-countdown');
    if (countdownElement) {
        countdownElement.querySelector('h2').textContent = 'Promotion termin√©e !';
        countdownElement.classList.add('ended');
        console.log('üèÅ Promotion termin√©e');
    }
}
function resetCountdownForAll() {
    if (confirm('Voulez-vous vraiment r√©initialiser le compte √† rebours ?')) {
        localStorage.removeItem('promoEndDate');
        console.log('üîÑ Compte √† rebours r√©initialis√© pour tous les appareils');
        location.reload();
    }
}
function updateFloatingCart() {
    console.log('üîÑ Mise √† jour du panier flottant...');
    
    const cartItemsContainer = document.getElementById('cart-items-floating');
    const cartTotalElement = document.getElementById('cart-total-floating');
    const cartBadge = document.getElementById('cart-badge-floating');

    if (!cartItemsContainer || !cartTotalElement || !cartBadge) {
        console.error('‚ùå √âl√©ments du panier non trouv√©s');
        return;
    }

    let total = 0;
    let totalItems = 0;

    cartItemsContainer.innerHTML = '';

    if (floatingCart.length === 0) {
        cartItemsContainer.innerHTML = '<div class="empty-cart-floating">Votre panier est vide</div>';
        cartTotalElement.textContent = '0';
        cartBadge.textContent = '0';
        console.log('üõí Panier vide');
        return;
    }

    floatingCart.forEach((item, index) => {
        totalItems += item.quantity;
        const itemTotal = (item.promoPrice || item.price) * item.quantity;
        total += itemTotal;

        const itemElement = document.createElement('div');
        itemElement.className = 'cart-item-floating';
        itemElement.innerHTML = `
            <div class="cart-item-info">
                <h4>${item.name}</h4>
                <p>Quantit√©: ${item.quantity}</p>
            </div>
            <div class="cart-item-price">
                ${itemTotal} MRU
                <button class="remove-item" onclick="removeFromFloatingCart(${index})">‚ùå</button>
            </div>
        `;
        cartItemsContainer.appendChild(itemElement);
    });

    cartTotalElement.textContent = Math.round(total);
    cartBadge.textContent = totalItems;
    
    console.log(`‚úÖ Panier mis √† jour: ${totalItems} articles, Total: ${total} MRU`);
}
function removeFromFloatingCart(index) {
    if (floatingCart[index]) {
        const productName = floatingCart[index].name;
        floatingCart.splice(index, 1);
        localStorage.setItem('anduxara_cart', JSON.stringify(floatingCart));
        updateFloatingCart();
        showNotification(`üóëÔ∏è ${productName} retir√© du panier`);
    }
}
function ajouterAuPanier(productName, category, price) {
    console.log('üõí Ajout au panier:', productName, 'Prix:', price + ' MRU');
    
    if (navigator.vibrate) navigator.vibrate(50);

    const existingItem = floatingCart.find(item => item.name === productName);

    if (existingItem) {
        existingItem.quantity += 1;
    } else {
        floatingCart.push({
            name: productName,
            category: category,
            price: price,
            promoPrice: price,
            quantity: 1,
            addedAt: new Date().toISOString()
        });
    }
    
    localStorage.setItem('anduxara_cart', JSON.stringify(floatingCart));
    showNotification('‚úÖ ' + productName + ' ajout√© au panier !');
    updateFloatingCart();
    
    if (typeof trackAddToCart === 'function') {
        trackAddToCart(productName, category, price);
    }
}
function toggleFloatingCart() {
    console.log('üõí toggleFloatingCart appel√©');
    const cart = document.getElementById('floating-cart');
    if (cart) {
        cart.classList.toggle('open');
        console.log("Panier √©tat:", cart.classList.contains('open') ? "ouvert" : "ferm√©");
        if (cart.classList.contains('open')) {
            updateFloatingCart();
        }
    }
}
function closeFloatingCart() {
    const cart = document.getElementById('floating-cart');
    if (cart) {
        cart.classList.remove('open');
    }
}    
    // Vibration si support√©
    if (navigator.vibrate) navigator.vibrate(50);

    // Synchroniser floatingCart avec localStorage
    
    // Rechercher si le produit existe d√©j√†

    if (existingItem) {
        existingItem.quantity += 1;

    } else {
        cartItems.push({
            name: productName,
            price: promoPrice,
            quantity: 1,
            addedAt: new Date().toISOString()
        });
    }
    
    // Sauvegarder dans le localStorage
    localStorage.setItem('anduxara_cart', JSON.stringify(floatingCart));
    
    // Afficher une notification
    showNotification('‚úÖ ' + productName + ' ajout√© au panier !');
    
    // Mettre √† jour l'affichage du panier
}
function showNotification(message) {
    // Cr√©er la notification
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #25D366;
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 10000;
        animation: slideInRight 0.3s ease;
    `;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Supprimer apr√®s 3 secondes
    setTimeout(() => {
        notification.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}
function updateCartCounter() {
    const cart = JSON.parse(localStorage.getItem('anduxara_cart')) || [];
    const counter = document.getElementById('cart-counter');
    
    if (counter) {
        counter.textContent = cart.length;
        counter.style.display = cart.length > 0 ? 'inline' : 'none';
    }
}
function addToCartFromModal(productName, productPrice) {
    // Nettoyer le prix (enlever "MRU" et espaces)
    const cleanPrice = parseInt(productPrice.toString().replace(' MRU', '').replace(/\s/g, ''));
    
    // Utiliser la fonction addToCart
    addToCart(productName, cleanPrice, cleanPrice);
    
    // Fermer le modal
    const modal = document.querySelector('div[style*="position: fixed"]');
    if (modal) modal.remove();
}
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Initialisation du syst√®me de livraison...');

// V√©rifier la synchronisation des codes promo
    verifierSynchronisationPromo();
    
    // R√©appliquer la r√©duction si le panier change
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList') {
                appliquerReductionPanier();
            }
    
    // Observer les changements dans le panier
    const panierContainer = document.getElementById('panier');
    if (panierContainer) {
        observer.observe(panierContainer, { childList: true, subtree: true });
        
    // √âv√©nement pour la touche Entr√©e
    const addressInput = document.getElementById('delivery-address');
    if (addressInput) {
        addressInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkDelivery();
            }
        });
    }
    
// ===== CORRECTION DYNAMIQUE BOUTONS MOBILE =====
function fixMobileButtons() {
    const isPortrait = window.innerHeight > window.innerWidth;
    const isMobile = window.innerWidth <= 768;
    
    if (isMobile && isPortrait) {
        console.log('üì± Mode portrait mobile d√©tect√© - Correction des boutons...');
        
        // Correction livraison
        fixDeliverySection();
        
        // Correction assistant IA
        fixAIAssistant();
        
        // Correction options livraison
        fixDeliveryOptions();
    }
}
function fixDeliverySection() {
    const locationInput = document.querySelector('.location-input');
    const deliveryButton = document.querySelector('.location-input button');
    const deliveryInput = document.getElementById('delivery-address');
    
    if (locationInput && deliveryButton && deliveryInput) {
        // Forcer l'affichage
        locationInput.style.display = 'flex';
        locationInput.style.flexDirection = 'column';
        locationInput.style.gap = '12px';
        
        deliveryButton.style.display = 'block';
        deliveryButton.style.width = '100%';
        deliveryButton.style.opacity = '1';
        deliveryButton.style.visibility = 'visible';
        deliveryButton.style.order = '2';
        
        deliveryInput.style.order = '1';
        deliveryInput.style.width = '100%';
        
        console.log('‚úÖ Bouton livraison corrig√©');
    }
}
function fixAIAssistant() {
    const aiInput = document.getElementById('ai-input');
    let aiButton = document.querySelector('#ai-send-button') || 
                   document.querySelector('#ai-input + button') ||
                   document.querySelector('button[onclick*="sendAIMessage"]');
    
    console.log('üîç Recherche bouton IA:', {
        input: !!aiInput,
        button: !!aiButton,
        buttonText: aiButton?.textContent
    });
    
    if (aiInput && aiButton) {
        // Donner un ID sp√©cifique au bouton
        if (!aiButton.id) {
            aiButton.id = 'ai-send-button';
        }
        
        // Cr√©er le conteneur principal si n√©cessaire
        let aiContainer = document.getElementById('ai-input-container');
        if (!aiContainer) {
            aiContainer = document.createElement('div');
            aiContainer.id = 'ai-input-container';
            aiContainer.style.display = 'flex';
            aiContainer.style.flexDirection = 'column';
            aiContainer.style.gap = '12px';
            aiContainer.style.width = '100%';
            
            // Ins√©rer le conteneur
            aiInput.parentNode.insertBefore(aiContainer, aiInput);
        }
        
        // Cr√©er le groupe input + bouton
        let aiGroup = document.getElementById('ai-input-group');
        if (!aiGroup) {
            aiGroup = document.createElement('div');
            aiGroup.id = 'ai-input-group';
            aiGroup.style.display = 'flex';
            aiGroup.style.gap = '10px';
            aiGroup.style.alignItems = 'center';
            aiGroup.style.width = '100%';
            
            // Ajouter au conteneur
            aiContainer.appendChild(aiGroup);
        }
        
        // R√©organiser les √©l√©ments dans le groupe
        if (!aiGroup.contains(aiInput)) {
            aiGroup.appendChild(aiInput);
        }
        if (!aiGroup.contains(aiButton)) {
            aiGroup.appendChild(aiButton);
        }
        
        // Styles forc√©s pour le bouton
        aiButton.style.display = 'flex';
        aiButton.style.alignItems = 'center';
        aiButton.style.justifyContent = 'center';
        aiButton.style.padding = '15px 25px';
        aiButton.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
        aiButton.style.color = 'white';
        aiButton.style.border = 'none';
        aiButton.style.borderRadius = '25px';
        aiButton.style.cursor = 'pointer';
        aiButton.style.fontWeight = '600';
        aiButton.style.fontSize = '1rem';
        aiButton.style.minWidth = '120px';
        aiButton.style.minHeight = '50px';
        aiButton.style.opacity = '1';
        aiButton.style.visibility = 'visible';
        aiButton.style.whiteSpace = 'nowrap';
        aiButton.style.flexShrink = '0';
        
        // Styles pour l'input
        aiInput.style.flex = '1';
        aiInput.style.minHeight = '50px';
        aiInput.style.padding = '15px 20px';
        aiInput.style.fontSize = '1rem';
        aiInput.style.borderRadius = '25px';
        aiInput.style.border = '2px solid #e2e8f0';
        
        console.log('‚úÖ Bouton IA corrig√© avec succ√®s');
        
    } else if (aiInput && !aiButton) {
        // Cr√©er le bouton s'il n'existe pas
        console.log('‚ö†Ô∏è Bouton IA non trouv√©, cr√©ation...');
        createAISendButton();
    } else {
        console.log('‚ùå √âl√©ments IA non trouv√©s');
    }
}
function createAISendButton() {
    const aiInput = document.getElementById('ai-input');
    if (!aiInput) return;
    
    // Cr√©er le bouton
    const aiButton = document.createElement('button');
    aiButton.id = 'ai-send-button';
    aiButton.innerHTML = 'Envoyer üöÄ';
    aiButton.onclick = sendAIMessage;
    
    // Styles du bouton
    aiButton.style.cssText = `
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 15px 25px;
        border-radius: 25px;
        cursor: pointer;
        font-weight: 600;
        font-size: 1rem;
        min-width: 120px;
        min-height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 1;
        visibility: visible;
        white-space: nowrap;
        flex-shrink: 0;
    `;
    
    // Cr√©er la structure
    const aiContainer = document.createElement('div');
    aiContainer.id = 'ai-input-container';
    aiContainer.style.cssText = `
        display: flex;
        flex-direction: column;
        gap: 12px;
        width: 100%;
    `;
    
    const aiGroup = document.createElement('div');
    aiGroup.id = 'ai-input-group';
    aiGroup.style.cssText = `
        display: flex;
        gap: 10px;
        align-items: center;
        width: 100%;
    `;
    
    // R√©organiser
    aiInput.parentNode.insertBefore(aiContainer, aiInput);
    aiGroup.appendChild(aiInput);
    aiGroup.appendChild(aiButton);
    aiContainer.appendChild(aiGroup);
    
    console.log('‚úÖ Bouton IA cr√©√© avec succ√®s');
}
function fixDeliveryOptions() {
    const options = document.querySelectorAll('.option');
    
    options.forEach(option => {
        option.style.display = 'flex';
        option.style.flexDirection = 'column';
        option.style.alignItems = 'center';
        option.style.textAlign = 'center';
        option.style.gap = '8px';
        option.style.opacity = '1';
        option.style.visibility = 'visible';
    });
    
    console.log(`‚úÖ ${options.length} options livraison corrig√©es`);
}
function initMobileButtonObserver() {
    // Corriger au chargement
    setTimeout(fixMobileButtons, 100);
    
    // Corriger lors du redimensionnement
    window.addEventListener('resize', fixMobileButtons);
    
    // Corriger lors du changement d'orientation
    window.addEventListener('orientationchange', function() {
        setTimeout(fixMobileButtons, 300);
    });
    
    // Observer les mutations du DOM au cas o√π des √©l√©ments seraient ajout√©s dynamiquement
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.addedNodes.length) {
                setTimeout(fixMobileButtons, 100);
            }
        });
    });
    
    observer.observe(document.body, {
        childList: true,
        subtree: true
    });
}
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Initialisation du panier et fid√©lit√©...');
    
    // Charger le panier depuis le localStorage
    floatingCart = JSON.parse(localStorage.getItem('anduxara_cart')) || [];
    
    // Charger le code promo actif
    const savedPromo = localStorage.getItem('anduxara_active_promo');
    if (savedPromo) {
        const promoData = JSON.parse(savedPromo);
        activePromoCode = promoData.code;
        promoDiscount = promoData.discount;
        updateActivePromoDisplay();
    }

// ===== CORRECTION BOUTONS MOBILE =====
    console.log('üì± Initialisation correcteur boutons mobile...');
    initMobileButtonObserver();
    console.log('‚úÖ Correcteur boutons mobile activ√©');    
    // Mettre √† jour l'affichage initial du panier
    updateFloatingCart();

    // Fermer le panier en cliquant √† l'ext√©rieur
    document.addEventListener('click', function(event) {
        const cart = document.getElementById('floating-cart');
        const toggle = document.querySelector('.cart-toggle');

        if (cart && cart.classList.contains('open') &&
            !cart.contains(event.target) &&
            !toggle.contains(event.target)) {
            closeFloatingCart();
        }
    });
    
    // Initialiser le syst√®me de recommandations
    window.styleAdvisor = new StyleAdvisor();
    
    // Mettre √† jour les recommandations apr√®s le chargement
    setTimeout(() => {
        if (window.styleAdvisor && typeof window.styleAdvisor.updateRecommendations === 'function') {
            window.styleAdvisor.updateRecommendations();
            console.log('‚úÖ Syst√®me de recommandations IA activ√© !');
        }
    }, 1500);
    
    // ===== V√âRIFICATION SYST√àME DE PAIEMENT =====
    console.log('‚úÖ V√©rification du syst√®me de paiement...');
    
    // V√©rifier que toutes les fonctions sont disponibles
    if (typeof processFloatingCheckout === 'function') {
        console.log('‚úÖ processFloatingCheckout pr√™t');
    } else {
        console.error('‚ùå processFloatingCheckout NON D√âFINI');
    }
    
    if (typeof processWavePayment === 'function') {
        console.log('‚úÖ processWavePayment pr√™t');
    } else {
        console.error('‚ùå processWavePayment NON D√âFINI');
    }
    
    if (typeof processBankilyPayment === 'function') {
        console.log('‚úÖ processBankilyPayment pr√™t');
    } else {
        console.error('‚ùå processBankilyPayment NON D√âFINI');
    }
    
    if (typeof processWhatsAppPayment === 'function') {
        console.log('‚úÖ processWhatsAppPayment pr√™t');
    } else {
        console.error('‚ùå processWhatsAppPayment NON D√âFINI');
    }
    
    console.log('üéØ Panier charg√© avec', floatingCart.length, 'produits');
    
});

    // √âv√©nements pour les options de livraison
    const options = document.querySelectorAll('.option');
    options.forEach(option => {
        option.addEventListener('click', function() {
            selectDeliveryOption(this.dataset.type);
        });
    });
    
    // Initialiser la vue rapide
    setupQuickView();
    updateCartCounter();
    
    console.log('‚úÖ Panier, vue rapide et livraison initialis√©s');
});

document.head.appendChild(assistantStyle);
// ===== TABLEAU DE BORD CLIENT INTELLIGENT =====
class ClientDashboard {
    constructor() {
        this.userData = this.loadUserData();
        this.initializeDashboard();
    }

    loadUserData() {
        return JSON.parse(localStorage.getItem('anduxara_user_dashboard')) || {
            viewedProducts: [],
            favoriteProducts: [],
            purchaseHistory: [],
            preferences: {
                favoriteCategories: [],
                priceRange: { min: 0, max: 2000 },
                preferredSizes: []
            },
            stats: {
                totalViews: 0,
                totalFavorites: 0,
                lastVisit: null
            }
        };
    }

    saveUserData() {
        localStorage.setItem('anduxara_user_dashboard', JSON.stringify(this.userData));
    }

    initializeDashboard() {
        this.updateDashboardDisplay();
        // Mettre √† jour les stats de visite
        this.userData.stats.lastVisit = new Date().toISOString();
        this.saveUserData();
    }

    // Track quand un produit est consult√©
    trackProductView(productName, category, price) {
        const existingView = this.userData.viewedProducts.find(
            item => item.name === productName
        );

        if (existingView) {
            existingView.viewCount += 1;
            existingView.lastViewed = new Date().toISOString();
    } else {
        {
            name: productName,
            price: promoPrice,
            quantity: 1,
            addedAt: new Date().toISOString()
        }
    });  

        this.userData.stats.totalViews += 1;
        this.updatePreferences(category, price);
        this.saveUserData();
        this.updateDashboardDisplay();
    }

    // Ajouter aux favoris
    addToFavorites(productName, category, price) {
        const existingFavorite = this.userData.favoriteProducts.find(
            item => item.name === productName
        );

        if (!existingFavorite) {
            this.userData.favoriteProducts.push({
                name: productName,
                category: category,
                price: price,
                addedAt: new Date().toISOString()
            });

            this.userData.stats.totalFavorites += 1;
            this.saveUserData();
            this.updateDashboardDisplay();
            this.showNotification('‚ù§Ô∏è Ajout√© aux favoris !');
        }
    }

    // Retirer des favoris
    removeFromFavorites(productName) {
        this.userData.favoriteProducts = this.userData.favoriteProducts.filter(
            item => item.name !== productName
        );
        this.userData.stats.totalFavorites = Math.max(0, this.userData.stats.totalFavorites - 1);
        this.saveUserData();
        this.updateDashboardDisplay();
        this.showNotification('üóëÔ∏è Retir√© des favoris');
    }

    // Mettre √† jour les pr√©f√©rences
    updatePreferences(category, price) {
        // Mettre √† jour les cat√©gories pr√©f√©r√©es
        const categoryIndex = this.userData.preferences.favoriteCategories.findIndex(
            item => item.name === category
        );

        if (categoryIndex > -1) {
            this.userData.preferences.favoriteCategories[categoryIndex].count += 1;
        } else {
            this.userData.preferences.favoriteCategories.push({
                name: category,
                count: 1
            });
        }

        // Mettre √† jour la fourchette de prix
        if (price < this.userData.preferences.priceRange.min) {
            this.userData.preferences.priceRange.min = price;
        }
        if (price > this.userData.preferences.priceRange.max) {
            this.userData.preferences.priceRange.max = price;
        }
    }

    // G√©n√©rer des recommandations personnalis√©es
    generateRecommendations() {
        const recommendations = [];
        const favoriteCategories = this.userData.preferences.favoriteCategories
            .sort((a, b) => b.count - a.count)
            .slice(0, 2)
            .map(item => item.name);

        // Bas√© sur les cat√©gories pr√©f√©r√©es
        favoriteCategories.forEach(category => {
            const productsInCategory = this.getAllProducts().filter(
                product => product.category === category
            );
            recommendations.push(...productsInCategory.slice(0, 2));
        });

        // M√©langer et limiter
        return this.shuffleArray(recommendations).slice(0, 4);
    }

    // Mettre √† jour l'affichage du dashboard
    updateDashboardDisplay() {
        this.updateViewHistory();
        this.updateFavorites();
        this.updateRecommendations();
        this.updateStats();
    }

    updateViewHistory() {
        const container = document.getElementById('view-history');
        if (!container) return;

        const recentViews = this.userData.viewedProducts
            .sort((a, b) => new Date(b.lastViewed) - new Date(a.lastViewed))
            .slice(0, 5);

        if (recentViews.length === 0) {
            container.innerHTML = '<p style="color: #999; text-align: center; font-style: italic;">Aucun produit consult√©</p>';
            return;
        }

container.innerHTML = recentViews.map(product => `
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
        <div style="flex: 1;">
            <div style="font-weight: 500; font-size: 0.9rem;">${product.name}</div>
            <div style="font-size: 0.8rem; color: #666;">Vu ${product.viewCount} fois</div>
        </div>
        <div style="font-weight: bold; color: #667eea; font-size: 0.9rem;">${product.price} MRU</div>
    </div>
`).join('');
} // ‚úÖ AJOUTEZ CETTE FERMETURE ICI

updateFavorites() {

        const container = document.getElementById('saved-products');
        if (!container) return;

        const favorites = this.userData.favoriteProducts
            .sort((a, b) => new Date(b.addedAt) - new Date(a.addedAt))
            .slice(0, 5);

        if (favorites.length === 0) {
            container.innerHTML = '<p style="color: #999; text-align: center; font-style: italic;">Aucun favori</p>';
            return;
        }

container.innerHTML = favorites.map(product => `
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
        <div style="flex: 1;">
            <div style="font-weight: 500; font-size: 0.9rem;">${product.name}</div>
            <div style="font-size: 0.8rem; color: #666;">${product.category}</div>
        </div>
        <div>
            <button onclick="clientDashboard.removeFromFavorites('${product.name}')"
                    style="background: #e74c3c; color: white; border: none; padding: 4px 8px; border-radius: 12px; cursor: pointer; font-size: 0.7rem;">
                Retirer
            </button>
        </div>
    </div>
`).join('');
}
        if (typeof showNotification === 'function') {
            showNotification(message);
        } else {
            alert(message);
        }
    }
}
function resetDashboard() {
    if (confirm('√ätes-vous s√ªr de vouloir r√©initialiser votre tableau de bord ? Toutes vos donn√©es seront effac√©es.')) {
        localStorage.removeItem('anduxara_user_dashboard');
        clientDashboard = new ClientDashboard();
        showNotification('‚úÖ Tableau de bord r√©initialis√© !');
    }
}
document.addEventListener('DOMContentLoaded', function() {
    clientDashboard = new ClientDashboard();
    
    // Surcharger la fonction trackProductView existante
    const originalTrackProductView = window.trackProductView;
    window.trackProductView = function(productName, category, price) {
        if (clientDashboard) {
            clientDashboard.trackProductView(productName, category, price);
        }
        if (originalTrackProductView) {
            originalTrackProductView(productName, category, price);
        }
    };

    // Ajouter des boutons favoris aux produits
    addFavoriteButtonsToProducts();
});

function addFavoriteButtonsToProducts() {
    // Ajouter des boutons favoris √† chaque produit
    document.querySelectorAll('.product-card').forEach(card => {
        const productName = card.querySelector('.product-title').textContent;
        const productCategory = card.getAttribute('data-category');
        const productPrice = parseInt(card.querySelector('.promo-price').textContent);
        
        const favoriteBtn = document.createElement('button');
        favoriteBtn.innerHTML = '‚ù§Ô∏è';
        favoriteBtn.style.cssText = `
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            cursor: pointer;
            font-size: 1rem;
            z-index: 10;
            transition: transform 0.2s;
        `;
        
        favoriteBtn.onclick = function(e) {
            e.stopPropagation();
            clientDashboard.addToFavorites(productName, productCategory, productPrice);
            this.style.transform = 'scale(1.2)';
            setTimeout(() => this.style.transform = 'scale(1)', 200);
        };
        
        card.querySelector('.product-image-container').appendChild(favoriteBtn);
    });
}
function initMobileFitting() {
    const cameraContainer = document.getElementById('camera-container');
    const virtualFittingSection = document.getElementById('virtual-fitting');
    
    if (!cameraContainer || !virtualFittingSection) return;
    
    function adjustFittingLayout() {
        const isMobile = window.innerWidth <= 768;
        const isPortrait = window.innerHeight > window.innerWidth;
        
        if (isMobile) {
            // Mode mobile
            virtualFittingSection.style.padding = "20px 10px";
            
            if (isPortrait) {
                // Mode portrait - layout vertical
                const fittingContainer = document.querySelector('.fitting-container');
                if (fittingContainer) {
                    fittingContainer.style.gridTemplateColumns = "1fr";
                }
                cameraContainer.style.height = "200px";
            } else {
                // Mode paysage - layout horizontal
                const fittingContainer = document.querySelector('.fitting-container');
                if (fittingContainer) {
                    fittingContainer.style.gridTemplateColumns = "1fr 1fr";
                }
                cameraContainer.style.height = "250px";
            }
        } else {
            // Mode desktop
            const fittingContainer = document.querySelector('.fitting-container');
            if (fittingContainer) {
                fittingContainer.style.gridTemplateColumns = "1fr 1fr";
            }
            cameraContainer.style.height = "400px";
        }
    }
    
    // √âcouter les changements d'orientation et de taille
    window.addEventListener('resize', adjustFittingLayout);
    window.addEventListener('orientationchange', adjustFittingLayout);
    
    // Appliquer au chargement
    adjustFittingLayout();
}
document.addEventListener('DOMContentLoaded', function() {
    // ... code existant ...
    
    // AJOUTEZ CETTE LIGNE √† la fin du DOMContentLoaded existant :
    initMobileFitting();
});

</script>
    <!-- ... VOTRE CONTENU EXISTANT ... -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <!-- ‚úÖ BANNI√àRE COOKIES RGPD -->
    <div id="cookie-banner" style="display: none; position: fixed; bottom: 0; left: 0; right: 0; background: #2c3e50; color: white; padding: 20px; text-align: center; z-index: 10000; box-shadow: 0 -2px 10px rgba(0,0,0,0.3);">
        <div style="max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
            <div style="flex: 1; min-width: 300px; text-align: left;">
                <p style="margin: 0; font-size: 16px; line-height: 1.5;">
                    <span style="font-size: 20px; margin-right: 10px;">üç™</span>
                    Nous utilisons des cookies pour am√©liorer votre exp√©rience. 
                    <a href="#" onclick="showCookiePolicy()" style="color: #667eea; text-decoration: underline;">En savoir plus</a>
                </p>
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="acceptAllCookies()" style="background: #27ae60; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                    ‚úÖ Tout accepter
                </button>
                <button onclick="acceptNecessaryCookies()" style="background: #3498db; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                    üîß Uniquement n√©cessaires
                </button>
                <button onclick="rejectAllCookies()" style="background: #e74c3c; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                    ‚ùå Tout refuser
                </button>
            </div>
        </div>
    </div>

    <!-- ‚úÖ MODAL POLITIQUE COOKIES -->
    <div id="cookie-policy" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10001; justify-content: center; align-items: center;">
        <div style="background: white; border-radius: 15px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; padding: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #2c3e50;">üç™ Politique des Cookies</h3>
                <button onclick="closeCookiePolicy()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
            </div>
            <div style="line-height: 1.6; color: #555;">
                <p><strong>Cookies n√©cessaires :</strong> Essentiels au fonctionnement du site (panier, pr√©f√©rences)</p>
                <p><strong>Cookies analytics :</strong> Nous aident √† am√©liorer le site (Google Analytics)</p>
                <p><strong>Cookies marketing :</strong> Publicit√©s personnalis√©es (d√©sactiv√©s par d√©faut)</p>
                <p>Vous pouvez modifier vos pr√©f√©rences √† tout moment.</p>
            </div>
            <button onclick="closeCookiePolicy()" style="background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 600; margin-top: 20px;">
                Fermer
            </button>
        </div>
    </div>

    <!-- ‚úÖ SCRIPT COOKIES SIMPLE -->
    <script>
        // üç™ GESTION COOKIES SIMPLIFI√âE
        console.log('üç™ Script cookies charg√©');
        
        function showCookiePolicy() {
            document.getElementById('cookie-policy').style.display = 'flex';
            console.log('üìÑ Politique cookies affich√©e');
        }
        
        function closeCookiePolicy() {
            document.getElementById('cookie-policy').style.display = 'none';
        }
        
        function acceptAllCookies() {
            localStorage.setItem('cookie_consent', 'all');
            localStorage.setItem('cookies_accepted', 'true');
            document.getElementById('cookie-banner').style.display = 'none';
            console.log('‚úÖ Tous les cookies accept√©s');
            alert('‚úÖ Pr√©f√©rences cookies sauvegard√©es !');
        }
        
        function acceptNecessaryCookies() {
            localStorage.setItem('cookie_consent', 'necessary');
            localStorage.setItem('cookies_accepted', 'true');
            document.getElementById('cookie-banner').style.display = 'none';
            console.log('üîß Cookies n√©cessaires accept√©s');
            alert('üîß Cookies n√©cessaires accept√©s');
        }
        
        function rejectAllCookies() {
            localStorage.setItem('cookie_consent', 'none');
            localStorage.setItem('cookies_accepted', 'true');
            document.getElementById('cookie-banner').style.display = 'none';
            console.log('‚ùå Tous les cookies refus√©s');
            alert('‚ùå Cookies refus√©s');
        }
        
        // Afficher la banni√®re apr√®s 2 secondes si pas d√©j√† fait
        setTimeout(function() {
            const accepted = localStorage.getItem('cookies_accepted');
            if (!accepted) {
                document.getElementById('cookie-banner').style.display = 'block';
                console.log('üç™ Banni√®re cookies affich√©e');
            }
        }, 2000);
// üß™ TEST BANNI√àRE
console.log('üîç Test banni√®re cookies:');
console.log('- Banni√®re trouv√©e:', !!document.getElementById('cookie-banner'));
console.log('- Policy trouv√©e:', !!document.getElementById('cookie-policy'));
console.log('- Consentement:', localStorage.getItem('cookies_accepted'));

// Forcer l'affichage pour test
setTimeout(() => {
    document.getElementById('cookie-banner').style.display = 'block';
    console.log('‚úÖ Banni√®re affich√©e manuellement');
}, 1000);


// ===== VARIABLES GLOBALES =====
let floatingCart = JSON.parse(localStorage.getItem('anduxara_cart')) || [];

function ajouterAuPanier(productName, category, price) {
    console.log('üõí Ajout au panier:', productName, 'Prix:', price + ' MRU');
    
    if (navigator.vibrate) navigator.vibrate(50);

    const existingItem = floatingCart.find(item => item.name === productName);

    if (existingItem) {
        existingItem.quantity += 1;
    } else {
        floatingCart.push({
            name: productName,
            category: category,
            price: price,
            promoPrice: price,
            quantity: 1,
            addedAt: new Date().toISOString()
        });
    }
    
    localStorage.setItem('anduxara_cart', JSON.stringify(floatingCart));
    showNotification('‚úÖ ' + productName + ' ajout√© au panier !');
    updateFloatingCart();
    
    // ‚≠ê‚≠ê AJOUT IMPORTANT : Track l'ajout au panier
    trackAddToCart(productName, category, price);
}
function updateFloatingCart() {
    const cartItemsContainer = document.getElementById('cart-items-floating');
    const cartTotalElement = document.getElementById('cart-total-floating');
    const cartBadge = document.getElementById('cart-badge-floating');

    if (!cartItemsContainer || !cartTotalElement || !cartBadge) return;

    let total = 0;
    let totalItems = 0;

    cartItemsContainer.innerHTML = '';

    if (floatingCart.length === 0) {
        cartItemsContainer.innerHTML = '<div class="empty-cart-floating">Votre panier est vide</div>';
        cartTotalElement.textContent = '0';
        cartBadge.textContent = '0';
        return;
    }

    floatingCart.forEach((item, index) => {
        totalItems += item.quantity;
        const itemTotal = (item.promoPrice || item.price) * item.quantity;
        total += itemTotal;

        const itemElement = document.createElement('div');
        itemElement.className = 'cart-item-floating';
        itemElement.innerHTML = `
            <div class="cart-item-info">
                <h4>${item.name}</h4>
                <p>Quantit√©: ${item.quantity}</p>
            </div>
            <div class="cart-item-price">
                ${itemTotal} MRU
                <button class="remove-item" onclick="removeFromFloatingCart(${index})">‚ùå</button>
            </div>
        `;
        cartItemsContainer.appendChild(itemElement);
    });


    cartTotalElement.textContent = Math.round(total);
    cartBadge.textContent = totalItems;
}
function removeFromFloatingCart(index) {
    floatingCart.splice(index, 1);
    localStorage.setItem('anduxara_cart', JSON.stringify(floatingCart));
    updateFloatingCart();
    showNotification('üóëÔ∏è Produit retir√© du panier');
}
function toggleFloatingCart() {
    console.log('üõí toggleFloatingCart appel√©');
    const cart = document.getElementById('floating-cart');
    if (cart) {
        cart.classList.toggle('open');
        console.log("Panier √©tat:", cart.classList.contains('open') ? "ouvert" : "ferm√©");
        if (cart.classList.contains('open') && typeof updateFloatingCart === 'function') {
            updateFloatingCart();
        }
    }
}
function closeFloatingCart() {
    const cart = document.getElementById('floating-cart');
    if (cart) {
        cart.classList.remove('open');
    }
}
function processFloatingCheckout() {
    console.log('üõí D√©but du processus de checkout avec promo...');

    if (floatingCart.length === 0) {
        showNotification('Panier vide !', 'error');
        return;
    }

    // R√âCUP√âRER LES INFOS PROMO
    const promoData = localStorage.getItem('commande_promo_info');
    let promoInfo = null;
    let totalMRU = floatingCart.reduce((sum, item) => {
        return sum + (item.promoPrice || item.price) * item.quantity;
    }, 0);

    if (promoData) {
        try {
            promoInfo = JSON.parse(promoData);
            console.log('üé´ Promotion appliqu√©e:', promoInfo);
        } catch (error) {
            console.log('‚ùå Erreur lecture promo');
        }
    }

    // APPLIQUER LA R√âDUCTION SI PROMO ACTIVE
    let reductionAppliquee = 0;
    if (promoInfo && promoInfo.discount) {
        reductionAppliquee = (totalMRU * promoInfo.discount) / 100;
        totalMRU = totalMRU - reductionAppliquee;
    }

    totalMRU = Math.round(totalMRU);
    const totalFCFA = Math.round(totalMRU * 2.5);

    // CONSTRUIRE LE MESSAGE AVEC INFO PROMO
    const productList = floatingCart.map(item => 
        `${item.name} (x${item.quantity}) - ${(item.promoPrice || item.price) * item.quantity} MRU`
    ).join('\n');

    let message = `Bonjour Andu-Xara ! üëã\n\n`;
    message += `Je souhaite commander :\n\n${productList}\n\n`;

    // AJOUTER LES INFOS PROMO DANS LE MESSAGE
    if (promoInfo) {
        message += `üé´ CODE PROMO APPLIQU√â : ${promoInfo.code}\n`;
        message += `üí∞ R√âDUCTION : ${promoInfo.discount}% (-${reductionAppliquee} MRU)\n\n`;
    }

    message += `üí∞ Total : ${totalMRU} MRU${promoInfo ? ` (apr√®s r√©duction)` : ''}\n\n`;
    message += `Pouvez-vous m'aider pour la suite ?`;

    // CHOIX DE PAIEMENT
    const paymentChoice = `üí≥ CHOISISSEZ VOTRE M√âTHODE DE PAIEMENT\n\nüí∞ Montant : ${totalMRU} MRU (${totalFCFA} FCFA)${promoInfo ? `\nüé´ R√©duction : ${promoInfo.discount}% appliqu√©e` : ''}\n\nüî¢ Tapez 1, 2 ou 3 :\n\n1Ô∏è‚É£ ‚Üí Wave S√©n√©gal (${totalFCFA} FCFA)\n2Ô∏è‚É£ ‚Üí Bankily Mauritanie (${totalMRU} MRU)\n3Ô∏è‚É£ ‚Üí WhatsApp (Discuter avec notre √©quire)\n\n‚ö†Ô∏è Votre choix (1/2/3) :`;

    const choice = prompt(paymentChoice);
    
    if (choice === '1') {
        processWavePayment(totalFCFA, totalMRU, message);
    } else if (choice === '2') {
        processBankilyPayment(totalMRU, message);
    } else if (choice === '3') {
        processWhatsAppPayment(message);
    } else {
        showNotification('Commande annul√©e', 'warning');
    }
}
function processWavePayment(totalFCFA, totalMRU, message) {
    const waveLink = "https://pay.wave.com/m/M_sn_WWTLh5q4mXHC/c/sn/";
    
    const waveMessage = `üåä PAIEMENT WAVE S√âN√âGAL\n\nüí∏ Montant : ${totalFCFA} FCFA\nüîó Lien de paiement : ${waveLink}\n\nüì± Instructions :\n1. Cliquez sur le lien Wave ci-dessus\n2. Confirmez le paiement de ${totalFCFA} FCFA\n\n‚úÖ OK ‚Üí Ouvrir Wave maintenant\n‚ùå Annuler ‚Üí Retour au choix de paiement`;
    
    if (confirm(waveMessage)) {
        window.open(waveLink, '_blank');
        
        setTimeout(() => {
            const instructions = `üìã INSTRUCTIONS WAVE COMPL√àTES\n\nSi Wave ne s'ouvre pas automatiquement :\n\n1. COPIEZ CE LIEN :\n${waveLink}\n\n2. COLLEZ-LE dans votre navigateur\n\n3. OU ouvrez l'application Wave et :\n‚Ä¢ Allez dans "Envoyer de l'argent"\n‚Ä¢ Num√©ro : +221 76 282 11 33\n‚Ä¢ Montant : ${totalFCFA} FCFA\n‚Ä¢ Message : "Commande Andu-Xara"\n\nüìû Besoin d'aide ? Contactez-nous sur WhatsApp !`;
            
            if (confirm(instructions)) {
                finaliserCommande(totalMRU, message, 'Wave');
            } else {
                const assistanceMessage = `üÜò J'ai besoin d'aide pour le paiement Wave\n\nMontant : ${totalFCFA} FCFA\n\nD√©tails :\n${message}`;
                window.open(`https://wa.me/221762821133?text=${encodeURIComponent(assistanceMessage)}`, '_blank');
            }
        }, 1000);
        
    } else {
        showNotification('Paiement Wave annul√©', 'info');
    }
}
function processBankilyPayment(totalMRU, message) {
    const bankilyMessage = `üè¶ PAIEMENT BANKILY MAURITANIE\n\nüí∏ Montant : ${totalMRU} MRU\nüì± Num√©ro Bankily : +222 49 03 76 97\n\nüìã Instructions :\n1. Ouvrez l'application Bankily\n2. Allez dans "Transf√©rer"\n3. Entrez le num√©ro : 49037697\n4. Montant : ${totalMRU} MRU\n5. Message : "Commande Andu-Xara"\n6. Confirmez la transaction\n\n‚úÖ OK ‚Üí J'ai effectu√© le transfert\n‚ùå Annuler ‚Üí Support WhatsApp`;
    
    if (confirm(bankilyMessage)) {
        const bankilyDeepLink = `bankily://transfer?phone=49037697&amount=${totalMRU}`;
        window.location.href = bankilyDeepLink;
        
        setTimeout(() => {
            const finalCheck = confirm(`‚úÖ TRANSFERT EFFECTU√â ?\n\nAvez-vous bien effectu√© le transfert Bankily ?\n\n‚Ä¢ Num√©ro : 49 03 76 97\n‚Ä¢ Montant : ${totalMRU} MRU\n\n‚úÖ OUI ‚Üí Finaliser la commande\n‚ùå NON ‚Üí Assistance WhatsApp`);
            
            if (finalCheck) {
                finaliserCommande(totalMRU, message, 'Bankily');
            } else {
                const assistanceMessage = `üÜò J'ai besoin d'aide pour le paiement Bankily\n\nMontant : ${totalMRU} MRU\n\nD√©tails :\n${message}`;
                window.open(`https://wa.me/22249037697?text=${encodeURIComponent(assistanceMessage)}`, '_blank');
            }
        }, 2000);
        
    } else {
        showNotification('Paiement Bankily annul√©', 'info');
    }
}
function processWhatsAppPayment(message) {
    const whatsappMessage = `üí¨ CONTACT WHATSAPP\n\nüì± Nous allons ouvrir WhatsApp pour :\n‚Ä¢ Confirmer votre commande\n‚Ä¢ Choisir le mode de paiement\n‚Ä¢ Organiser la livraison\n\nüïí R√©ponse sous 5 minutes !\n\n‚úÖ OK ‚Üí Ouvrir WhatsApp maintenant\n‚ùå Annuler ‚Üí Retour au panier`;
    
    if (confirm(whatsappMessage)) {
        const whatsappText = `Bonjour Andu-Xara ! üëã\n\nJe souhaite commander :\n\n${message}\n\nPouvez-vous m'aider pour la suite ?`;
        window.open(`https://wa.me/22249037697?text=${encodeURIComponent(whatsappText)}`, '_blank');
        
        showNotification('‚úÖ WhatsApp ouvert ! Notre √©quipe vous contactera.', 'success');
        
        setTimeout(() => {
            finaliserCommande(0, message, 'WhatsApp');
        }, 3000);
        
    } else {
        showNotification('Ouverture WhatsApp annul√©e', 'info');
    }
}
function finaliserCommande(totalMRU, message, methode) {
    const confirmation = `üéâ COMMANDE CONFIRM√âE !\n\n‚úÖ Votre commande a √©t√© enregistr√©e\nüí≥ M√©thode : ${methode}\nüí∞ Montant : ${totalMRU} MRU\n\nüì¶ Prochaines √©tapes :\n1. Notre √©quipe va vous contacter\n2. Confirmation sous 24h maximum\n3. Livraison express selon votre zone\n\nüìû Contact : +222 49 03 76 97\n\nMerci pour votre confiance ! ü§ù`;
    
    alert(confirmation);
    
    floatingCart = [];
    localStorage.setItem('anduxara_cart', JSON.stringify(floatingCart));
    updateFloatingCart();
    closeFloatingCart();
    showNotification('üéâ Commande finalis√©e ! Merci pour votre achat.', 'success');
}
async function verifierCodePersistant() {
    try {
        const user = firebase.auth().currentUser;
        if (!user) return null;

        // V√©rifier dans Firebase si l'utilisateur a un code actif
        const activeUsageQuery = await firebase.firestore()
            .collection('promoUsage')
            .where('userId', '==', user.uid)
            .where('status', '==', 'applied')
            .orderBy('usedAt', 'desc')
            .limit(1)
            .get();

        if (!activeUsageQuery.empty) {
            const lastUsage = activeUsageQuery.docs[0].data();
            const usageDate = lastUsage.usedAt?.toDate();
            const now = new Date();
            const diffHours = (now - usageDate) / (1000 * 60 * 60);

            // Code valide si utilis√© dans les 24h
            if (diffHours < 24) {
                return {
                    code: lastUsage.promoCode,
                    discount: lastUsage.discount,
                    persistent: true
                };
            }
        }
    } catch (error) {
        console.error('Erreur v√©rification code persistant:', error);
    }
    return null;
}
function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'error' ? '#ff4757' : '#25D366'};
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        z-index: 10000;
        animation: slideIn 0.3s ease;
        display: flex;
        align-items: center;
        gap: 10px;
        max-width: 350px;
    `;
    notification.innerHTML = `
        <span>${type === 'error' ? '‚ùå' : '‚úÖ'}</span>
        <span>${message}</span>
    `;

    document.body.appendChild(notification);

    setTimeout(() => {
        notification.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}
async function simulatePromoValidation(code) {
    const validCodes = {
        'BIENVENUE15': 15,
        'ANDU2025': 20,
        'SOLDE30': 30,
        'PREMIUM25': 25
    };
    
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    if (validCodes[code]) {
        return {
            valid: true,
            discount: validCodes[code],
            message: `R√©duction de ${validCodes[code]}% appliqu√©e`
        };
    } else {
        return {
            valid: false,
            message: 'Code invalide'
        };
    }
}
function trackProductView(productName, category, price) {
    if (window.styleAdvisor && typeof window.styleAdvisor.trackProductView === 'function') {
        window.styleAdvisor.trackProductView(productName, category, price);
    }
}
function trackAddToCart(productName, category, price) {
    if (window.styleAdvisor && typeof window.styleAdvisor.trackAddToCart === 'function') {
        window.styleAdvisor.trackAddToCart(productName, category, price);
    }
}
function checkDelivery() {
    console.log('üìç V√©rification de la livraison...');

    const addressInput = document.getElementById('delivery-address');
    const resultDiv = document.getElementById('delivery-result');

    if (!addressInput) {
        console.error('‚ùå Champ delivery-address non trouv√©');
        return;
    }

    if (!resultDiv) {
        console.error('‚ùå √âl√©ment delivery-result non trouv√©');
        return;
    }

    const address = addressInput.value.trim();

    // V√©rification de l'adresse
    if (!address || address.length < 5) {
        resultDiv.innerHTML = '<p style="color: red; padding: 10px; background: #ffe8e8; border-radius: 5px;">‚ùå L\'adresse doit contenir au moins 5 caract√®res</p>';
        return;
    }

    // Afficher le chargement
    resultDiv.innerHTML = '<p style="color: #667eea; padding: 10px; background: #f0f4ff; border-radius: 5px;">üîÑ Recherche de votre zone...</p>';

    // Simuler un d√©lai de v√©rification
    setTimeout(() => {
        const addressLower = address.toLowerCase();

        // Zones couvertes en Mauritanie
        const zonesCouvertes = [
            'nouakchott', 'nouadhibou', 'rosso', 'ka√©di', 'kiffa', 'atar', 'zou√©rat',
            't√©vregh zeina', 'el mina', 'ksar', 'sebkha', 'dar naim', 'toujounine',
            'arafat', 'ryad', 'socogim bagdad', 'socogim k', 'cit√© plage', 'socogim k',
            'tevregh', 'guidimakha', 'ksar', 'sebkha', 'couva', 'cinqui√©me', 'basra'
        ];

        let estCouvert = false;
        let message = '';
        let delai = '';

        // V√©rifier si la zone est couverte
        for (const zone of zonesCouvertes) {
            if (addressLower.includes(zone)) {
                estCouvert = true;

                if (addressLower.includes('nouakchott') ||
                    addressLower.includes('tevregh') ||
                   addressLower.includes('basra') ||
                    addressLower.includes('socogik k') ||
                    addressLower.includes('socogim ps') ||
                    addressLower.includes('socogim bagdad') ||
                    addressLower.includes('cinqui√©me') ||
                    addressLower.includes('mina') ||
                    addressLower.includes('ksar') ||
                    addressLower.includes('sebkha') ||
                    addressLower.includes('dar naim') ||
                    addressLower.includes('toujounine') ||
                    addressLower.includes('arafat') ||
                    addressLower.includes('ryad')) {
                    message = '‚úÖ Livraison EXPRESS disponible !';
                    delai = '‚è±Ô∏è Livraison en 24h - GRATUITE';
                } else {
                    message = '‚úÖ Livraison STANDARD disponible !';
                    delai = '‚è±Ô∏è Livraison en 3-5 jours - GRATUITE';
                }
                break;
            }
        }

        if (!estCouvert) {
            message = '‚ùå Livraison non disponible dans votre zone';
            delai = 'üìû Contactez-nous au +222 49 03 76 97';
        }

        // Afficher le r√©sultat
        resultDiv.innerHTML = `
            <div style="padding: 15px; border-radius: 10px; background: ${estCouvert ? '#e8f5e8' : '#ffe8e8'}; border: 2px solid ${estCouvert ? '#25D366' : '#ff4757'};">
                <h4 style="margin: 0 0 10px 0; color: ${estCouvert ? '#25D366' : '#ff4757'};">${message}</h4>
                <p style="margin: 0; font-weight: bold;">${delai}</p>
                ${estCouvert ? `
                    <div style="margin-top: 15px;">
                        <p style="margin: 5px 0; font-size: 14px;">üì¶ Livraison √† domicile incluse</p>
                        <p style="margin: 5px 0; font-size: 14px;">üí∞ Paiement √† la livraison possible</p>
                    </div>
                ` : `
                    <div style="margin-top: 15px;">
                        <p style="margin: 5px 0; font-size: 14px;">üí° Conseil : V√©rifiez l'orthographe de votre ville</p>
                        <p style="margin: 5px 0; font-size: 14px;">üìû Appelez-nous pour les commandes sp√©ciales</p>
                    </div>
                `}
            </div>
        `;
        
        console.log('üìç R√©sultat livraison:', message);
        
    }, 1000);
}
function selectDeliveryOption(type) {
    const options = document.querySelectorAll('.option');
    
    options.forEach(option => {
        option.classList.remove('selected');
        if (option.dataset.type === type) {
            option.classList.add('selected');
        }
    });
    
    showNotification(`‚úÖ Option ${type === 'express' ? 'Express (24h)' : 'Standard (3-5 jours)'} s√©lectionn√©e !`);
}
function handleDeliveryKeypress(event) {
    if (event.key === 'Enter') {
        checkDelivery();
    }
}
function genererRecuCommande(products, total, promoInfo = null) {
    console.log('üßæ G√©n√©ration du re√ßu...');
    
    let recu = `=== ANDU-XARA - RE√áU DE COMMANDE ===\n\n`;
    recu += `üìÖ Date: ${new Date().toLocaleString()}\n`;
    recu += `üÜî Commande: #${Date.now().toString().slice(-6)}\n\n`;
    
    recu += `üì¶ PRODUITS COMMAND√âS:\n`;
    recu += '‚îÄ'.repeat(40) + '\n';
    
    products.forEach((item, index) => {
        recu += `${index + 1}. ${item.name}\n`;
        recu += `   Quantit√©: ${item.quantity} x ${item.promoPrice || item.price} MRU\n`;
        recu += `   Sous-total: ${(item.promoPrice || item.price) * item.quantity} MRU\n\n`;
    });
    
    recu += '‚îÄ'.repeat(40) + '\n';
    
    if (promoInfo) {
        recu += `üé´ CODE PROMO: ${promoInfo.code}\n`;
        recu += `üí∞ R√âDUCTION: ${promoInfo.discount}%\n`;
        recu += `üéÅ ORIGINE: Promotion Andu-Xara\n\n`;
    }
    
    recu += `üí∞ TOTAL: ${total} MRU\n`;
    recu += `üí≥ Statut: En attente de paiement\n\n`;
    recu += `üìû Contact: +222 49 03 76 97\n`;
    recu += `üìß Email: anduxara2408@gmail.com\n\n`;
    recu += `Merci pour votre confiance ! üõçÔ∏è`;
    
    return recu;
}
        if (typeof showNotification === 'function') {
            showNotification(message, type);
        } else {
            alert(message);
        }
    }
}
function sendAIMessage() {
    if (!intelligentAssistant) {
        intelligentAssistant = new IntelligentAssistant();
    }
    intelligentAssistant.sendMessage();
}
function handleAIKeypress(event) {
    if (event.key === 'Enter') {
        sendAIMessage();
    }
}
        if (typeof showNotification === 'function') {
            showNotification(message);
        } else {
            alert(message);
        }
    }
}
function initClientDashboard() {
    if (!clientDashboard) {
        clientDashboard = new ClientDashboard();
    }
    return clientDashboard;
}
function resetDashboard() {
    if (confirm('√ätes-vous s√ªr de vouloir r√©initialiser votre tableau de bord ? Toutes vos donn√©es seront effac√©es.')) {
        localStorage.removeItem('anduxara_user_dashboard');
        clientDashboard = new ClientDashboard();
        showNotification('‚úÖ Tableau de bord r√©initialis√© !');
    }
}
function addFavoriteButtonsToProducts() {
    // Ajouter des boutons favoris √† chaque produit
    document.querySelectorAll('.product-card').forEach(card => {
        const productName = card.querySelector('.product-title').textContent;
        const productCategory = card.getAttribute('data-category');
        const productPrice = parseInt(card.querySelector('.promo-price').textContent);
        
        // V√©rifier si le bouton existe d√©j√†
        if (card.querySelector('.favorite-btn')) return;
        
        const favoriteBtn = document.createElement('button');
        favoriteBtn.className = 'favorite-btn';
        favoriteBtn.innerHTML = '‚ù§Ô∏è';
        favoriteBtn.style.cssText = `
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            cursor: pointer;
            font-size: 1rem;
            z-index: 10;
            transition: transform 0.2s;
        `;
        
        favoriteBtn.onclick = function(e) {
            e.stopPropagation();
            if (clientDashboard) {
                clientDashboard.addToFavorites(productName, productCategory, productPrice);
            }
            this.style.transform = 'scale(1.2)';
            setTimeout(() => this.style.transform = 'scale(1)', 200);
        };
        
        card.querySelector('.product-image-container').appendChild(favoriteBtn);
    });
}
function trackProductView(productName, category, price) {
    if (clientDashboard && typeof clientDashboard.trackProductView === 'function') {
        clientDashboard.trackProductView(productName, category, price);
    }
    
    // Track aussi pour les recommandations StyleAdvisor
    if (window.styleAdvisor && typeof window.styleAdvisor.trackProductView === 'function') {
        window.styleAdvisor.trackProductView(productName, category, price);
    }
}
function trackAddToCart(productName, category, price) {
    if (clientDashboard && typeof clientDashboard.trackAddToCart === 'function') {
        // Note: ClientDashboard n'a pas trackAddToCart, mais on peut l'ajouter si besoin
    }
    
    // Track pour les recommandations StyleAdvisor
    if (window.styleAdvisor && typeof window.styleAdvisor.trackAddToCart === 'function') {
        window.styleAdvisor.trackAddToCart(productName, category, price);
    }
}
        if (typeof showNotification === 'function') {
            showNotification(message, type);
        } else {
            alert(message);
        }
    }
}
function initVirtualFitting() {
    if (!virtualFittingAI) {
        virtualFittingAI = new VirtualFittingAI();
    }
    return virtualFittingAI;
}
function startVirtualFitting() {
    if (!virtualFittingAI) {
        virtualFittingAI = new VirtualFittingAI();
    }
    virtualFittingAI.startVirtualFitting();
}
function stopVirtualFitting() {
    if (virtualFittingAI) {
        virtualFittingAI.stopVirtualFitting();
    }
}
function selectClothing(productId) {
    if (!virtualFittingAI) {
        virtualFittingAI = new VirtualFittingAI();
    }
    
    // Mettre √† jour la s√©lection visuelle
    document.querySelectorAll('.clothing-option').forEach(option => {
        option.style.transform = option.dataset.product === productId ? 'scale(1.05)' : 'scale(1)';
        option.style.border = option.dataset.product === productId ? '2px solid #667eea' : '2px solid transparent';
    });
    
    virtualFittingAI.selectedClothing = productId;
    virtualFittingAI.showNotification(`üëï ${virtualFittingAI.clothingData[productId].name} s√©lectionn√© !`);
}
function adjustClothingSize() {
    if (virtualFittingAI) {
        virtualFittingAI.adjustClothingSize();
    }
}
function adjustClothingColor() {
    if (virtualFittingAI) {
        virtualFittingAI.adjustClothingColor();
    }
}
function captureVirtualFitting() {
    if (virtualFittingAI) {
        virtualFittingAI.captureVirtualFitting();
    }
}
function shareVirtualFitting() {
    if (virtualFittingAI) {
        virtualFittingAI.shareVirtualFitting();
    }
}
function addToCartFromFitting() {
    if (virtualFittingAI && virtualFittingAI.selectedClothing) {
        const clothing = virtualFittingAI.clothingData[virtualFittingAI.selectedClothing];
        ajouterAuPanier(clothing.name, clothing.category, clothing.price);
    }
}
function resetFitting() {
    const resultsContainer = document.getElementById('fitting-results');
    if (resultsContainer) {
        resultsContainer.style.display = 'none';
    }
    if (virtualFittingAI) {
        virtualFittingAI.showNotification('üîÑ Pr√™t pour un nouvel essai !');
    }
}
function setupQuickView() {
    console.log('üëÅÔ∏è Initialisation de la vue rapide...');
    
    document.querySelectorAll('.quick-view').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const productCard = this.closest('.product-card');
            if (!productCard) return;
            
            const productTitle = productCard.querySelector('.product-title')?.textContent || 'Produit';
            const productImage = productCard.querySelector('.product-img')?.src || 'images/logo.png';
            const productPrice = productCard.querySelector('.promo-price')?.textContent || '0 MRU';
            const productDescription = productCard.querySelector('.product-description')?.textContent || 'Description non disponible';
            const productCategory = productCard.getAttribute('data-category') || 'general';
            
            showQuickViewModal(productTitle, productImage, productPrice, productDescription, productCategory);
        });
    });
    
    console.log('‚úÖ Vue rapide initialis√©e sur', document.querySelectorAll('.quick-view').length, 'boutons');
}
function showQuickViewModal(title, image, price, description, category) {
    console.log('üëÅÔ∏è Ouverture vue rapide:', title);
    
    // Fermer toute modale existante
    const existingModal = document.querySelector('.quick-view-modal');
    if (existingModal) {
        existingModal.remove();
    }
    
    const modal = document.createElement('div');
    modal.className = 'quick-view-modal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.9);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
        animation: fadeIn 0.3s ease;
    `;
    
    modal.innerHTML = `
        <div style="background: white; border-radius: 20px; max-width: 900px; width: 95%; max-height: 90vh; overflow-y: auto; position: relative; animation: scaleIn 0.3s ease;">
            <button onclick="closeQuickView()" style="position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.7); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; cursor: pointer; z-index: 10; display: flex; align-items: center; justify-content: center;">&times;</button>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0; min-height: 500px;">
                <!-- Colonne Image -->
                <div style="background: #f8f9fa; display: flex; align-items: center; justify-content: center; padding: 40px; border-radius: 20px 0 0 20px;">
                    <img src="${image}" alt="${title}" 
                         style="max-width: 100%; max-height: 400px; object-fit: contain; border-radius: 10px; box-shadow: 0 8px 25px rgba(0,0,0,0.15);"
                         onerror="this.src='images/logo.png'">
                </div>
                
                <!-- Colonne Informations -->
                <div style="padding: 40px; display: flex; flex-direction: column; justify-content: space-between;">
                    <div>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <span style="background: #667eea; color: white; padding: 4px 12px; border-radius: 15px; font-size: 0.8rem; font-weight: bold;">${category}</span>
                            <span style="background: #27ae60; color: white; padding: 4px 12px; border-radius: 15px; font-size: 0.8rem; font-weight: bold;">üî• Promo</span>
                        </div>
                        
                        <h2 style="color: #2c3e50; margin-bottom: 15px; font-size: 1.8rem; line-height: 1.3;">${title}</h2>
                        
                        <p style="color: #7f8c8d; margin-bottom: 25px; line-height: 1.6; font-size: 1.1rem;">${description}</p>
                        
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 25px;">
                            <div style="font-size: 2rem; font-weight: bold; color: #e74c3c;">${price}</div>
                            <div style="text-decoration: line-through; color: #888; font-size: 1.2rem;">${getOriginalPrice(price)} MRU</div>
                        </div>
                        
                        <!-- Options de taille -->
                        <div style="margin-bottom: 25px;">
                            <h4 style="color: #2c3e50; margin-bottom: 10px; font-size: 1.1rem;">üìè Tailles disponibles :</h4>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                ${generateSizeOptions(category)}
                            </div>
                        </div>
                        
                        <!-- Caract√©ristiques -->
                        <div style="margin-bottom: 25px;">
                            <h4 style="color: #2c3e50; margin-bottom: 10px; font-size: 1.1rem;">‚ú® Caract√©ristiques :</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9rem;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span>‚úÖ</span>
                                    <span>100% Coton</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span>‚úÖ</span>
                                    <span>Livraison gratuite</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span>‚úÖ</span>
                                    <span>Qualit√© premium</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span>‚úÖ</span>
                                    <span>Retour sous 7 jours</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    <div style="display: flex; gap: 15px;">
                        <button onclick="addToCartFromQuickView('${title.replace(/'/g, "\\'")}', '${category}', ${extractPrice(price)})" 
                                style="flex: 2; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 18px; border-radius: 12px; cursor: pointer; font-weight: bold; font-size: 1.1rem; transition: transform 0.2s;">
                            üõí Ajouter au panier
                        </button>
                        <button onclick="closeQuickView()" 
                                style="flex: 1; background: #95a5a6; color: white; border: none; padding: 18px; border-radius: 12px; cursor: pointer; font-weight: bold; font-size: 1.1rem; transition: transform 0.2s;">
                            Fermer
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Fermer en cliquant en dehors
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeQuickView();
        }
    });
    
    // Fermer avec la touche √âchap
    const closeOnEscape = function(e) {
        if (e.key === 'Escape') {
            closeQuickView();
            document.removeEventListener('keydown', closeOnEscape);
        }
    };
    document.addEventListener('keydown', closeOnEscape);
    
    // Track la vue du produit
    trackProductView(title, category, extractPrice(price));
}
function closeQuickView() {
    const modal = document.querySelector('.quick-view-modal');
    if (modal) {
        modal.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => {
            modal.remove();
        }, 300);
    }
}
function addToCartFromQuickView(productName, category, price) {
    ajouterAuPanier(productName, category, price);
    closeQuickView();
}
function getOriginalPrice(promoPrice) {
    // Simuler un prix original bas√© sur le prix promo
    const price = extractPrice(promoPrice);
    return Math.round(price * 1.3); // +30% pour le prix original
}
function extractPrice(priceText) {
    // Extraire le nombre du texte de prix
    const match = priceText.toString().match(/(\d+)/);
    return match ? parseInt(match[1]) : 0;
}
function generateSizeOptions(category) {
    const sizes = {
        't-shirts': ['XS', 'S', 'M', 'L', 'XL'],
        'ensembles': ['S', 'M', 'L', 'XL'],
        'enfants': ['3-5 ans', '6-8 ans', '9-12 ans'],
        'accessoires': ['Unique'],
        'pulls': ['S', 'M', 'L', 'XL']
    };
    
    const availableSizes = sizes[category] || ['S', 'M', 'L'];
    
    return availableSizes.map(size => `
        <button style="padding: 10px 15px; border: 2px solid #e2e8f0; background: white; border-radius: 8px; cursor: pointer; transition: all 0.3s; font-weight: 500;"
                onmouseover="this.style.borderColor='#667eea'; this.style.backgroundColor='#f8f9ff'"
                onmouseout="this.style.borderColor='#e2e8f0'; this.style.backgroundColor='white'"
                onclick="selectSize(this)">
            ${size}
        </button>
    `).join('');
}
function selectSize(button) {
    // Retirer la s√©lection pr√©c√©dente
    button.parentElement.querySelectorAll('button').forEach(btn => {
        btn.style.borderColor = '#e2e8f0';
        btn.style.backgroundColor = 'white';
        btn.style.color = '#333';
    });
    
    // S√©lectionner la nouvelle taille
    button.style.borderColor = '#667eea';
    button.style.backgroundColor = '#667eea';
    button.style.color = 'white';
}
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Initialisation du panier et fid√©lit√©...');
    
    // Charger le panier depuis le localStorage
    floatingCart = JSON.parse(localStorage.getItem('anduxara_cart')) || [];
    
    // NETTOYER LES ANCIENNES DONN√âES PARRAINAGE
    localStorage.removeItem('anduxara_user_data');
    localStorage.removeItem('anduxara_fidelite');
    localStorage.removeItem('anduxara_active_promo');
    // R√âINITIALISER LES PRIX SANS R√âDUCTION
    floatingCart.forEach(item => {
        item.promoPrice = item.price;
    });
    localStorage.setItem('anduxara_cart', JSON.stringify(floatingCart));
    
    // Mettre √† jour l'affichage initial du panier
    updateFloatingCart();

    // Fermer le panier en cliquant √† l'ext√©rieur
    document.addEventListener('click', function(event) {
        const cart = document.getElementById('floating-cart');
        const toggle = document.querySelector('.cart-toggle');

        if (cart && cart.classList.contains('open') &&
            !cart.contains(event.target) &&
            !toggle.contains(event.target)) {
            closeFloatingCart();
        }
    });
    
    // ===== INITIALISATION VUE RAPIDE =====
    console.log('üëÅÔ∏è Initialisation de la vue rapide...');
    setupQuickView();
    console.log('‚úÖ Vue rapide initialis√©e');
    
    // ===== INITIALISATION ESSAYAGE VIRTUEL =====
    console.log('ü™û Initialisation de l\'essayage virtuel IA...');
    virtualFittingAI = initVirtualFitting();
    console.log('‚úÖ Essayage virtuel IA initialis√©');
    
    // ===== INITIALISATION TABLEAU DE BORD CLIENT =====
    console.log('üìä Initialisation du tableau de bord client...');
    clientDashboard = initClientDashboard();
    
    // Ajouter les boutons favoris aux produits
    setTimeout(() => {
        addFavoriteButtonsToProducts();
        console.log('‚úÖ Boutons favoris ajout√©s aux produits');
    }, 1000);
    
    // ===== INITIALISATION SYST√àME DE PARRAINAGE =====
    // ===== INITIALISATION SYST√àME DE LIVRAISON =====
    console.log('üöö Initialisation du syst√®me de livraison...');
    
    // √âv√©nement pour la touche Entr√©e
    const addressInput = document.getElementById('delivery-address');
    if (addressInput) {
        addressInput.addEventListener('keypress', handleDeliveryKeypress);
        console.log('‚úÖ √âv√©nement Entr√©e initialis√© pour livraison');
    }
    
    // √âv√©nements pour les options de livraison
    const options = document.querySelectorAll('.option');
    options.forEach(option => {
        option.addEventListener('click', function() {
            selectDeliveryOption(this.dataset.type);
        });
    });
    
    console.log(`‚úÖ ${options.length} options de livraison initialis√©es`);
    
    // ===== INITIALISATION ASSISTANT IA =====
    console.log('ü§ñ Initialisation de l\'assistant IA...');
    intelligentAssistant = new IntelligentAssistant();
    
    // √âv√©nement pour la touche Entr√©e dans l'assistant
    const aiInput = document.getElementById('ai-input');
    if (aiInput) {
        aiInput.addEventListener('keypress', handleAIKeypress);
        console.log('‚úÖ √âv√©nement Entr√©e initialis√© pour assistant IA');
    }
    
    // ===== INITIALISATION SYST√àME DE RECOMMANDATIONS =====
    console.log('ü§ñ Initialisation du syst√®me de recommandations...');
    window.styleAdvisor = new StyleAdvisor();
    
    // Mettre √† jour les recommandations apr√®s le chargement
    setTimeout(() => {
        if (window.styleAdvisor && typeof window.styleAdvisor.updateRecommendations === 'function') {
            window.styleAdvisor.updateRecommendations();
            console.log('‚úÖ Syst√®me de recommandations IA activ√© !');
        } else {
            console.error('‚ùå Erreur initialisation recommandations');
        }
    }, 2000);
    
    // V√©rification du syst√®me de paiement
    console.log('‚úÖ V√©rification du syst√®me de paiement...');
    
    if (typeof processFloatingCheckout === 'function') {
        console.log('‚úÖ processFloatingCheckout pr√™t');
    } else {
        console.error('‚ùå processFloatingCheckout NON D√âFINI');
    }
    
    console.log('üéØ Panier charg√© avec', floatingCart.length, 'produits');
});

  </script>
<!-- Corrections permanentes - TEMPORAIREMENT D√âSACTIV√â -->
<!-- <script src="corrections-essentielles.js"></script> -->
<script>
// üîß TEMPORAIRE : Fichier corrections-essentielles.js d√©sactiv√©
console.log('‚úÖ Fichier corrections-essentielles.js temporairement d√©sactiv√©');
</script>
<script>
// ===== D√âTECTION ET OPTIMISATION MOBILE =====
function optimizeForMobile() {
    console.log('üì± Optimisation mobile en cours...');
    
    // D√©tection du dispositif
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    const isAndroid = /Android/.test(navigator.userAgent);
    
    if (isMobile) {
        document.body.classList.add('mobile-device');
        console.log('üì± Appareil mobile d√©tect√©');
        
        if (isIOS) {
            document.body.classList.add('ios-device');
            console.log('üçé Appareil iOS');
        }
        
        if (isAndroid) {
            document.body.classList.add('android-device');
            console.log('ü§ñ Appareil Android');
        }
        
        // Optimisations sp√©cifiques mobile
        optimizeTouchInteractions();
        preventHorizontalScroll();
        optimizeImagesForMobile();
    }
}
function optimizeTouchInteractions() {
    // Am√©liorer les interactions tactiles
    const touchElements = document.querySelectorAll('button, a, .product-card, .category-btn');
    touchElements.forEach(element => {
        element.style.cursor = 'pointer';
    });
}
function preventHorizontalScroll() {
    // Emp√™cher le d√©filement horizontal
    window.addEventListener('scroll', function() {
        if (window.scrollX !== 0) {
            window.scrollTo(0, window.scrollY);
        }
    });
    
    // Emp√™cher le zoom sur le document
    document.addEventListener('touchmove', function(e) {
        if (e.scale !== 1) {
            e.preventDefault();
        }
    }, { passive: false });
}
function optimizeImagesForMobile() {
    // Chargement optimis√© des images pour mobile
    const images = document.querySelectorAll('img[data-src]');
    const imageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                img.src = img.getAttribute('data-src');
                img.removeAttribute('data-src');
                imageObserver.unobserve(img);
            }
        });
    });
    
    images.forEach(img => imageObserver.observe(img));
}
document.addEventListener('DOMContentLoaded', function() {
    optimizeForMobile();
    
    // Re-optimiser lors du redimensionnement
    window.addEventListener('resize', optimizeForMobile);
    window.addEventListener('orientationchange', function() {
        setTimeout(optimizeForMobile, 100);
    });
});

// ===== CORRECTION HAUTEUR VIEWPORT MOBILE =====
function setViewportHeight() {
    let vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
}
function verifierCodePromoAuChargement() {
    const promoActif = localStorage.getItem('anduxara_promo_utilise');
    const promoData = localStorage.getItem('anduxara_active_promo');
    
    if (promoActif === 'true' && promoData) {
        try {
            const promo = JSON.parse(promoData);
            console.log('üé´ Code promo actif d√©tect√©:', promo.code, '-', promo.discount + '%');
            
            // Mettre √† jour l'affichage
            const display = document.getElementById('active-promo-display');
            const codeElement = document.getElementById('active-promo-code');
            
            if (display && codeElement) {
                display.style.display = 'block';
                codeElement.textContent = `${promo.code} (-${promo.discount}%)`;
            }
            
            // Appliquer la r√©duction au panier
            if (typeof updateFloatingCart === 'function') {
                setTimeout(updateFloatingCart, 500);
            }
            
        } catch (error) {
            console.error('Erreur lecture promo actif:', error);
        }
    }
}
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(verifierCodePromoAuChargement, 1000);
});
</script>
<script>
// ===== SYST√àME COMPLET DE GESTION DES CODES PROMO =====

// ===== R√âCEPTION DES CODES DEPUIS REDUCTIONS.HTML =====
function receivePromoCodeFromReductions() {
    console.log('üéØ R√©ception des codes promo - D√©marrage...');
    
    // M√©thode 1: R√©cup√©rer depuis l'URL
    const urlParams = new URLSearchParams(window.location.search);
    const codeFromURL = urlParams.get('codePromo');
    
    if (codeFromURL) {
        console.log('üì• Code re√ßu depuis URL:', codeFromURL);
        processIncomingPromoCode(codeFromURL);
        cleanURL();
        return;
    }
    
    // M√©thode 2: R√©cup√©rer depuis sessionStorage
    const codeFromSession = sessionStorage.getItem('anduxara_promo_code');
    if (codeFromSession) {
        console.log('üì• Code re√ßu depuis sessionStorage:', codeFromSession);
        processIncomingPromoCode(codeFromSession);
        
        // Nettoyer apr√®s utilisation
        sessionStorage.removeItem('anduxara_promo_code');
        sessionStorage.removeItem('anduxara_promo_timestamp');
        return;
    }
    
    // M√©thode 3: √âcouter les messages entre pages
    window.addEventListener('message', function(event) {
        if (event.data && event.data.type === 'APPLY_PROMO_CODE') {
            const code = event.data.code;
            console.log('üì® Code re√ßu via postMessage:', code);
            processIncomingPromoCode(code);
        }
    });
    
    console.log('üéØ Syst√®me de r√©ception des codes promo activ√©');
}
function processIncomingPromoCode(code) {
    if (!code) return;
    
    console.log('üîÑ Traitement du code entrant:', code);
    
    // Sauvegarder temporairement
    localStorage.setItem('anduxara_promo_code', code);
    localStorage.setItem('anduxara_promo_timestamp', Date.now());
    
    // Appliquer automatiquement apr√®s un court d√©lai
    setTimeout(() => {
        applyPromoCodeAutomatically(code);
        
        // Afficher une notification
        showNotification(`üéâ Code "${code}" appliqu√© automatiquement !`);
        
    }, 1000);
}
function getPromoCodeFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('codePromo');
}
function getPromoCodeFromStorage() {
    const savedCode = localStorage.getItem('anduxara_promo_code');
    const savedTime = localStorage.getItem('anduxara_promo_timestamp');
    
    // V√©rifier si le code est encore valide (30 minutes)
    if (savedCode && savedTime && (Date.now() - savedTime < 30 * 60 * 1000)) {
        return savedCode;
    }
    return null;
}
function applyPromoCodeAutomatically(code) {
    console.log('üéØ Application automatique du code:', code);
    
    if (!code) return;
    
    // Remplir le champ et appliquer
    const promoInput = document.getElementById('promoInput');
    if (promoInput) {
        promoInput.value = code;
        validateAndApplyPromo();
    }
}
function updateActivePromoDisplay() {
    const display = document.getElementById('active-promo-display');
    const codeElement = document.getElementById('active-promo-code');
    
    if (!display || !codeElement) return;
    
    const promoData = localStorage.getItem('anduxara_active_promo');
    
    if (promoData) {
        try {
            const promo = JSON.parse(promoData);
            display.style.display = 'block';
            codeElement.textContent = `${promo.code} (-${promo.discount}%)`;
        } catch (error) {
            console.error('Erreur lecture promo:', error);
        }
    } else {
        display.style.display = 'none';
    }
}
function applyDiscountToCart(discount) {
    floatingCart.forEach(item => {
        // Calculer le nouveau prix promo
        const discountAmount = (item.price * discount) / 100;
        item.promoPrice = Math.round(item.price - discountAmount);
    });
    
    // Sauvegarder le panier mis √† jour
    localStorage.setItem('anduxara_cart', JSON.stringify(floatingCart));
    
    // Mettre √† jour l'affichage du panier
    if (typeof updateFloatingCart === 'function') {
        updateFloatingCart();
    }
    
    console.log(`üí∞ R√©duction de ${discount}% appliqu√©e au panier`);
}
function removePromoFromCart() {
    // R√©initialiser les prix dans le panier
    floatingCart.forEach(item => {
        item.promoPrice = item.price;
    });
    
    // Sauvegarder le panier
    localStorage.setItem('anduxara_cart', JSON.stringify(floatingCart));
    
    // Supprimer les donn√©es promo
    localStorage.removeItem('anduxara_active_promo');
    localStorage.removeItem('anduxara_promo_utilise');
    
    // Mettre √† jour l'affichage
    updateActivePromoDisplay();
    updateFloatingCart();
    
    // Mettre √† jour le message
    const messageElement = document.getElementById('promoMessage');
    if (messageElement) {
        messageElement.innerHTML = `<span style="color: #666;">üîì Code promo retir√©</span>`;
        setTimeout(() => {
            messageElement.style.display = 'none';
        }, 3000);
    }
    
    console.log('üóëÔ∏è Code promo retir√©');
}
function initPromoSystem() {
    console.log('üéØ Initialisation du syst√®me promo...');
    
    // V√©rifier l'URL d'abord
    const urlCode = getPromoCodeFromURL();
    if (urlCode) {
        console.log('üì• Code d√©tect√© dans URL:', urlCode);
        applyPromoCodeAutomatically(urlCode);
        
        // Nettoyer l'URL
        cleanURL();
        return;
    }
    
    // V√©rifier le localStorage ensuite
    const storageCode = getPromoCodeFromStorage();
    if (storageCode) {
        console.log('üì• Code d√©tect√© dans storage:', storageCode);
        applyPromoCodeAutomatically(storageCode);
        
        // Nettoyer le storage apr√®s utilisation
        localStorage.removeItem('anduxara_promo_code');
        localStorage.removeItem('anduxara_promo_timestamp');
        return;
    }
    
    // V√©rifier s'il y a un code actif sauvegard√©
    const activePromo = localStorage.getItem('anduxara_active_promo');
    if (activePromo) {
        console.log('üì• Code actif d√©j√† pr√©sent');
        updateActivePromoDisplay();
    }
}
function cleanURL() {
    const cleanURL = window.location.pathname;
    window.history.replaceState({}, document.title, cleanURL);
}
function appliquerReductionPanier(codeActif) {
    console.log('üí∞ Application r√©duction:', codeActif.discount + '%');
    
    // Mettre √† jour le panier avec la r√©duction
    const panier = JSON.parse(localStorage.getItem('panier')) || [];
    
    if (panier.length > 0) {
        panier.forEach(produit => {
            // Sauvegarder le prix original si pas d√©j√† fait
            if (!produit.prixOriginal) {
                produit.prixOriginal = produit.prix;
            }
            
            // Calculer le prix r√©duit
            const reduction = codeActif.discount / 100;
            produit.prixReduit = Math.round(produit.prixOriginal * (1 - reduction));
            produit.prix = produit.prixReduit;
            produit.reduction = codeActif.discount;
            produit.codePromo = codeActif.code;
        });
        
        // Sauvegarder le panier mis √† jour
        localStorage.setItem('panier', JSON.stringify(panier));
        console.log('‚úÖ Panier mis √† jour avec r√©duction');
    }
    
    // Afficher le badge de r√©duction
    afficherBadgeReduction(codeActif);
    
    // Mettre √† jour l'affichage du panier
    if (typeof afficherPanier === 'function') {
        afficherPanier();
    }
}
function afficherBadgeReduction(codeActif) {
    // Supprimer l'ancien badge s'il existe
    const ancienBadge = document.getElementById('badge-reduction-active');
    if (ancienBadge) {
        ancienBadge.remove();
    }
    
    // Cr√©er le nouveau badge
    const badge = document.createElement('div');
    badge.id = 'badge-reduction-active';
    badge.innerHTML = `
        <div style="background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; padding: 12px 20px; border-radius: 10px; margin: 15px 0; text-align: center; box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3); border: 2px solid #27ae60;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px; flex-wrap: wrap;">
                <div style="font-size: 1.5rem;">üéâ</div>
                <div style="text-align: left;">
                    <strong style="font-size: 1.1rem;">R√âDUCTION ACTIVE</strong>
                    <div style="font-size: 0.9rem; opacity: 0.9;">
                        Code: <strong>${codeActif.code}</strong> ‚Ä¢ -${codeActif.discount}% 
                        ${codeActif.description ? '<br>' + codeActif.description : ''}
                    </div>
                </div>
                <button onclick="retirerReduction()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: all 0.3s;">
                    ‚ùå Retirer
                </button>
            </div>
        </div>
    `;
    
    // Ajouter le badge en haut de la page
    const header = document.querySelector('header');
    const main = document.querySelector('main');
    if (header) {
        header.insertAdjacentElement('afterend', badge);
    } else if (main) {
        main.insertAdjacentElement('beforebegin', badge);
    } else {
        document.body.insertAdjacentElement('afterbegin', badge);
    }
    
    console.log('‚úÖ Badge r√©duction affich√©');
function retirerReduction() {
    console.log('üóëÔ∏è Retrait de la r√©duction...');
    
    // Supprimer les donn√©es de promotion
    localStorage.removeItem('anduxara_active_promo');
    localStorage.removeItem('anduxara_cart_promo');
    
    // Supprimer le badge
    const badge = document.getElementById('badge-reduction-active');
    if (badge) {
        badge.remove();
    }
    
    // Restaurer les prix originaux dans le panier
    const panier = JSON.parse(localStorage.getItem('panier')) || [];
    panier.forEach(produit => {
        if (produit.prixOriginal) {
            produit.prix = produit.prixOriginal;
            delete produit.prixReduit;
            delete produit.reduction;
            delete produit.codePromo;
        }
    });
    
    localStorage.setItem('panier', JSON.stringify(panier));
    
    // Rafra√Æchir l'affichage du panier
    if (typeof afficherPanier === 'function') {
        afficherPanier();
    }
    
    // Afficher une notification
    if (typeof showNotification === 'function') {
        showNotification('üîì R√©duction retir√©e', 'success');
    } else {
        alert('üîì R√©duction retir√©e');
    }
    
    console.log('‚úÖ R√©duction retir√©e');
}
    if (typeof afficherPanier === 'function') {
        afficherPanier();
    }
    
    // Afficher une notification
    if (typeof showNotification === 'function') {
        showNotification('üîì R√©duction retir√©e', 'success');
    } else {
        alert('üîì R√©duction retir√©e');
    }
    
    console.log('‚úÖ R√©duction retir√©e');
}
function formatPrix(prix) {
    return new Intl.NumberFormat('fr-FR', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(prix);
}
function verifierSynchronisationPromo() {
    console.log('üîç V√©rification synchronisation promo...');
    
    // V√©rifier si on vient de reductions.html avec un code
    const urlParams = new URLSearchParams(window.location.search);
    const codePromo = urlParams.get('codePromo');
    
    if (codePromo) {
        console.log('üéØ Code promo d√©tect√© dans URL:', codePromo);
        // Nettoyer l'URL
        window.history.replaceState({}, document.title, window.location.pathname);
    }
    
    // V√©rifier et appliquer les r√©ductions existantes
    setTimeout(() => {
        appliquerReductionPanier();
    }, 1000);
}
window.processFloatingCheckout = function() {
    // R√©cup√©rer les infos promo avant de proc√©der
    const promoData = localStorage.getItem('anduxara_active_promo');
    if (promoData) {
        try {
            const promo = JSON.parse(promoData);
            localStorage.setItem('commande_promo_info', JSON.stringify({
                code: promo.code,
                discount: promo.discount,
                appliedAt: promo.appliedAt
            }));
            console.log('üé´ Info promo sauvegard√©e pour commande:', promo.code);
        } catch (error) {
            console.error('Erreur sauvegarde info promo:', error);
        }
    }
    
    // Appeler la fonction originale
    if (originalProcessFloatingCheckout) {
        originalProcessFloatingCheckout();
    }
};

// ===== INITIALISATION COMPL√àTE =====
function initCompletePromoSystem() {
    // 1. D√©marrer la r√©ception des codes
    receivePromoCodeFromReductions();
    
    // 2. Initialiser le syst√®me promo
    setTimeout(initPromoSystem, 1500);
    setTimeout(updateActivePromoDisplay, 1000);
    
    console.log('‚úÖ Syst√®me promo complet initialis√©');
}
document.addEventListener('DOMContentLoaded', function() {
    initCompletePromoSystem();
});

// Quand l'utilisateur finalise sa commande
async function finaliserCommande() {
    // ... vos validations existantes ...
    
    // Gestion du code promo
    const promoData = localStorage.getItem('anduxara_active_promo');
    if (promoData) {
        const promo = JSON.parse(promoData);
        const user = firebase.auth().currentUser;
        
        if (user && promo.persistent) {
            await marquerCodeUtilise(user.uid, promo.code);
        }
        
        // Nettoyer le localStorage
        localStorage.removeItem('anduxara_active_promo');
        localStorage.removeItem('anduxara_cart_promo');
    }
    
    // Continuer avec le processus de paiement...
}
