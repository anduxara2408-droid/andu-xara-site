<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon compte - Andu-Xara</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Styles sp√©cifiques √† la page compte */
        .profile-section {
            padding: 60px 0;
            min-height: 60vh;
        }
        .profile-header {
            margin-bottom: 40px;
        }
        .profile-header h1 {
            font-size: 2.5rem;
            color: var(--gray-900);
        }
        .profile-header p {
            color: var(--gray-600);
        }
        .profile-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        .profile-card {
            background: var(--gray-50);
            padding: 30px;
            border-radius: var(--radius);
            transition: var(--transition);
        }
        .profile-card:hover {
            box-shadow: var(--shadow-hover);
        }
        .profile-card.highlight {
            background: linear-gradient(135deg, #fff3e0, white);
            border: 2px solid var(--primary);
        }
        .profile-card.full-width {
            grid-column: 1 / -1;
            background: white;
            border: 1px solid var(--gray-200);
        }
        .profile-card h2 {
            margin-bottom: 20px;
            color: var(--gray-800);
        }
        .profile-info p {
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid var(--gray-200);
        }
        .profile-info p:last-child {
            border-bottom: none;
        }
        .rewards-box {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: white;
            border-radius: var(--radius);
        }
        .rewards-number {
            font-size: 3rem;
            font-weight: 700;
            color: var(--primary);
            line-height: 1;
        }
        .rewards-label {
            color: var(--gray-600);
            font-size: 0.9rem;
        }
        .promo-item {
            background: white;
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: var(--radius);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }
        .promo-code {
            font-weight: 600;
            color: var(--primary);
        }
        .promo-discount {
            background: var(--primary);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }
        .promo-date {
            color: var(--gray-500);
            font-size: 0.8rem;
        }
        .tickets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .ticket-card {
            background: white;
            padding: 20px;
            border-radius: var(--radius);
            text-align: center;
            border: 1px solid var(--gray-200);
            transition: var(--transition);
        }
        .ticket-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-hover);
            border-color: var(--primary);
        }
        .ticket-qr {
            width: 150px;
            height: 150px;
            margin: 15px auto;
            display: block;
        }
        .ticket-id {
            font-size: 0.7rem;
            color: var(--gray-500);
            word-break: break-all;
            margin: 10px 0;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--gray-500);
            grid-column: 1 / -1;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--gray-200);
            padding-bottom: 10px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-radius: var(--radius);
            transition: var(--transition);
        }
        .tab:hover {
            background: var(--gray-100);
        }
        .tab.active {
            background: var(--primary);
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: var(--radius);
            text-align: center;
            border: 1px solid var(--gray-200);
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }
        .stat-label {
            font-size: 0.8rem;
            color: var(--gray-600);
        }
        @media (max-width: 768px) {
            .profile-grid {
                grid-template-columns: 1fr;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- TOP BAR -->
    <div class="top-bar">
        <div class="container">
            <div class="top-message">
                ‚ú® <strong>Andu-Xara</strong> - Votre espace personnel
            </div>
            <div class="top-links">
                <a href="contact.html">Contact</a>
                <a href="billetterie.html">üé´ Concerts</a>
                <a href="index.html">Accueil</a>
            </div>
        </div>
    </div>

    <!-- HEADER -->
    <header class="main-header">
        <div class="container">
            <div class="header-content">
                <a href="index.html" class="logo">
                    Andu<span>Xara</span>
                </a>
                <nav class="nav-menu">
                    <a href="index.html#collection" class="nav-link">Collection</a>
                    <a href="index.html#philosophie" class="nav-link">Notre histoire</a>
                    <a href="billetterie.html" class="nav-link">üé´ Concerts</a>
                    <a href="compte.html" class="nav-link nav-link-highlight">Mon compte</a>
                </nav>
                <div class="header-actions">
                    <a href="panier.html" class="cart-icon">
                        üõí<span class="cart-count" id="cartCount">0</span>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- SECTION COMPTE -->
    <section class="profile-section">
        <div class="container">
            <div class="profile-header">
                <h1>üë§ Mon espace personnel</h1>
                <p>G√©rez votre profil, vos r√©ductions et vos billets de concert</p>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <div class="tab active" onclick="showTab('profil')">üë§ Profil</div>
                <div class="tab" onclick="showTab('reductions')">üéÅ R√©ductions</div>
                <div class="tab" onclick="showTab('billets')">üé´ Mes billets</div>
                <div class="tab" onclick="showTab('stats')">üìä Statistiques</div>
            </div>

            <!-- Tab Profil -->
            <div id="tab-profil" class="tab-content active">
                <div class="profile-grid">
                    <!-- Infos personnelles -->
                    <div class="profile-card">
                        <h2>üë§ Mes informations</h2>
                        <div class="profile-info" id="profileInfo">
                            <p><strong>Nom :</strong> <span id="profileName">-</span></p>
                            <p><strong>Email :</strong> <span id="profileEmail">-</span></p>
                            <p><strong>T√©l√©phone :</strong> <span id="profilePhone">-</span></p>
                            <p><strong>Membre depuis :</strong> <span id="profileSince">-</span></p>
                        </div>
                        <button class="btn btn-outline" style="margin-top: 20px;" onclick="editProfile()">
                            ‚úèÔ∏è Modifier mes informations
                        </button>
                    </div>

                    <!-- Statistiques rapides -->
                    <div class="profile-card">
                        <h2>üìä En bref</h2>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div style="text-align: center;">
                                <div style="font-size: 2rem; color: var(--primary);" id="quickTickets">0</div>
                                <div style="font-size: 0.9rem; color: var(--gray-600);">Billets</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2rem; color: var(--primary);" id="quickPoints">0</div>
                                <div style="font-size: 0.9rem; color: var(--gray-600);">Points</div>
                            </div>
                        </div>
                        <button class="btn btn-primary" style="margin-top: 20px; width: 100%;" onclick="showTab('billets')">
                            Voir mes billets
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tab R√©ductions -->
            <div id="tab-reductions" class="tab-content">
                <div class="profile-grid">
                    <!-- Points fid√©lit√© -->
                    <div class="profile-card highlight">
                        <h2>üéÅ Mes r√©compenses</h2>
                        <div class="rewards-box">
                            <div class="rewards-number" id="rewardsPoints">0</div>
                            <div class="rewards-label">Points fid√©lit√©</div>
                        </div>
                        <p style="color: var(--gray-600); font-size: 0.9rem; text-align: center;">
                            Gagnez 1 point pour chaque 100 MRU d'achat
                        </p>
                    </div>

                    <!-- Historique des codes promo -->
                    <div class="profile-card">
                        <h2>üìú Historique des codes</h2>
                        <div id="promoHistory" style="max-height: 300px; overflow-y: auto;">
                            <!-- Historique charg√© dynamiquement -->
                            <div class="empty-state">Aucun code utilis√© pour le moment</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Billets -->
            <div id="tab-billets" class="tab-content">
                <div class="profile-card full-width">
                    <h2>üé´ Mes billets de concert</h2>
                    <div class="tickets-grid" id="ticketsList">
                        <!-- Billets charg√©s dynamiquement -->
                        <div class="empty-state">Aucun billet pour le moment</div>
                    </div>
                </div>
            </div>

            <!-- Tab Statistiques -->
            <div id="tab-stats" class="tab-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="statTickets">0</div>
                        <div class="stat-label">Billets achet√©s</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statSpent">0</div>
                        <div class="stat-label">Total d√©pens√©</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statPoints">0</div>
                        <div class="stat-label">Points gagn√©s</div>
                    </div>
                </div>

                <div class="profile-card full-width">
                    <h2>üìà Activit√© r√©cente</h2>
                    <div id="recentActivity">
                        <!-- Activit√© charg√©e dynamiquement -->
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- MODAL D'√âDITION DE PROFIL -->
    <div id="editProfileModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeEditModal()">&times;</span>
            <h2>Modifier mon profil</h2>
            <form id="editProfileForm" onsubmit="saveProfile(event)">
                <div class="form-group">
                    <label for="editName">Nom complet</label>
                    <input type="text" id="editName" required>
                </div>
                <div class="form-group">
                    <label for="editPhone">T√©l√©phone</label>
                    <input type="tel" id="editPhone" placeholder="+222 XX XX XX XX">
                </div>
                <button type="submit" class="btn btn-primary btn-block">
                    Enregistrer les modifications
                </button>
            </form>
        </div>
    </div>

    <!-- FOOTER -->
    <footer class="footer">
        <div class="container">
            <div class="footer-grid">
                <div class="footer-col">
                    <h4>Andu-Xara</h4>
                    <p>Mode et culture depuis 2020. Votre espace personnel.</p>
                </div>
                <div class="footer-col">
                    <h4>Liens</h4>
                    <ul>
                        <li><a href="index.html">Accueil</a></li>
                        <li><a href="billetterie.html">Concerts</a></li>
                        <li><a href="contact.html">Contact</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>Contact</h4>
                    <ul>
                        <li><a href="mailto:contact@andu-xara.store">contact@andu-xara.store</a></li>
                        <li>+222 34 19 63 04</li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>¬© 2026 Andu-Xara - Tous droits r√©serv√©s</p>
            </div>
        </div>
    </footer>

    <!-- SCRIPTS -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <script src="js/firebase.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/tickets.js"></script>
    
    <script>
        // ===== GESTION DES TABS =====
        window.showTab = function(tabName) {
            // Cacher tous les tabs
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            
            // Afficher le tab s√©lectionn√©
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
        };

        // ===== CHARGER LES DONN√âES DU COMPTE =====
        async function loadAccountData() {
            const user = auth.currentUser;
            if (!user) {
                window.location.href = '/?needLogin=true';
                return;
            }

            try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                const userData = userDoc.data();

                // Mettre √† jour les infos profil
                document.getElementById('profileName').textContent = userData.displayName || '-';
                document.getElementById('profileEmail').textContent = user.email;
                document.getElementById('profilePhone').textContent = userData.phone || '-';
                document.getElementById('profileSince').textContent = userData.createdAt ? 
                    new Date(userData.createdAt.seconds * 1000).toLocaleDateString() : '-';

                // Points fid√©lit√©
                const rewards = userData.rewards || 0;
                document.getElementById('rewardsPoints').textContent = rewards;
                document.getElementById('quickPoints').textContent = rewards;
                document.getElementById('statPoints').textContent = rewards;

                // Billets
                const tickets = userData.tickets || [];
                document.getElementById('quickTickets').textContent = tickets.length;
                document.getElementById('statTickets').textContent = tickets.length;
                document.getElementById('cartCount').textContent = tickets.length;

                // Afficher les billets
                displayTickets(tickets);

                // Afficher l'historique des promos
                displayPromoHistory(userData.promoHistory || []);

                // Calculer le total d√©pens√©
                const totalSpent = tickets.reduce((sum, t) => sum + (t.price || 0), 0);
                document.getElementById('statSpent').textContent = totalSpent + ' MRU';

                // Activit√© r√©cente
                displayRecentActivity(userData);

            } catch (error) {
                console.error('Erreur chargement donn√©es:', error);
            }
        }

        // ===== AFFICHER LES BILLETS =====
        function displayTickets(tickets) {
            const container = document.getElementById('ticketsList');
            
            if (!tickets || tickets.length === 0) {
                container.innerHTML = '<div class="empty-state">Aucun billet pour le moment</div>';
                return;
            }

            container.innerHTML = tickets.map(ticket => `
                <div class="ticket-card">
                    <div style="font-size: 2rem; margin-bottom: 10px;">üé´</div>
                    <h4 style="margin-bottom: 5px;">${ticket.concertName}</h4>
                    <p style="color: var(--gray-600); font-size: 0.9rem;">${new Date(ticket.concertDate).toLocaleDateString()}</p>
                    <img src="${ticket.qrCode}" alt="QR Code" class="ticket-qr">
                    <div class="ticket-id">${ticket.ticketId}</div>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button class="btn btn-outline btn-small" onclick="downloadTicket('${ticket.ticketId}')">
                            üì• T√©l√©charger
                        </button>
                        <button class="btn btn-primary btn-small" onclick="viewTicket('${ticket.ticketId}')">
                            üëÅÔ∏è Voir
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // ===== AFFICHER L'HISTORIQUE DES PROMOS =====
        function displayPromoHistory(history) {
            const container = document.getElementById('promoHistory');
            
            if (!history || history.length === 0) {
                container.innerHTML = '<div class="empty-state">Aucun code utilis√© pour le moment</div>';
                return;
            }

            container.innerHTML = history.map(promo => `
                <div class="promo-item">
                    <div>
                        <span class="promo-code">${promo.code}</span>
                        <span class="promo-discount">-${promo.discount}%</span>
                    </div>
                    <span class="promo-date">${new Date(promo.usedAt).toLocaleDateString()}</span>
                </div>
            `).join('');
        }

        // ===== AFFICHER L'ACTIVIT√â R√âCENTE =====
        function displayRecentActivity(userData) {
            const container = document.getElementById('recentActivity');
            const activities = [];

            // Ajouter les achats r√©cents
            if (userData.tickets) {
                userData.tickets.slice(0, 5).forEach(ticket => {
                    activities.push({
                        type: 'ticket',
                        date: new Date(ticket.purchasedAt || Date.now()),
                        text: `Achat de billet pour ${ticket.concertName}`,
                        icon: 'üé´'
                    });
                });
            }

            // Ajouter les codes promo utilis√©s
            if (userData.promoHistory) {
                userData.promoHistory.slice(0, 5).forEach(promo => {
                    activities.push({
                        type: 'promo',
                        date: new Date(promo.usedAt),
                        text: `Utilisation du code ${promo.code} (-${promo.discount}%)`,
                        icon: 'üéÅ'
                    });
                });
            }

            // Trier par date (plus r√©cent d'abord)
            activities.sort((a, b) => b.date - a.date);

            if (activities.length === 0) {
                container.innerHTML = '<div class="empty-state">Aucune activit√© r√©cente</div>';
                return;
            }

            container.innerHTML = activities.slice(0, 10).map(act => `
                <div class="promo-item">
                    <div>
                        <span style="margin-right: 10px;">${act.icon}</span>
                        ${act.text}
                    </div>
                    <span class="promo-date">${act.date.toLocaleDateString()}</span>
                </div>
            `).join('');
        }

        // ===== T√âL√âCHARGER UN BILLET =====
        window.downloadTicket = async function(ticketId) {
            try {
                const ticketDoc = await db.collection('tickets').doc(ticketId).get();
                const ticket = ticketDoc.data();

                // Cr√©er un contenu texte pour le billet
                const content = `
ANDU-XARA - BILLET OFFICIEL
===========================

Concert: ${ticket.concertName}
Date: ${new Date(ticket.concertDate).toLocaleDateString()}
Heure: ${ticket.concertTime || '20:00'}
Lieu: ${ticket.concertLocation}
Type: ${ticket.ticketTypeName}
Prix: ${ticket.price} MRU

Billet N¬∞: ${ticket.ticketId}
Client: ${ticket.userName}
Email: ${ticket.userEmail}

QR Code: ${ticket.qrCode}
                `;

                const blob = new Blob([content], {type: 'text/plain'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `billet-${ticketId}.txt`;
                a.click();
                
                alert('‚úÖ Billet t√©l√©charg√©');
                
            } catch (error) {
                console.error('Erreur t√©l√©chargement:', error);
                alert('‚ùå Erreur lors du t√©l√©chargement');
            }
        };

        // ===== VOIR UN BILLET =====
        window.viewTicket = async function(ticketId) {
            try {
                const ticketDoc = await db.collection('tickets').doc(ticketId).get();
                const ticket = ticketDoc.data();

                // Ouvrir l'image QR dans un nouvel onglet
                window.open(ticket.qrCode, '_blank');
                
            } catch (error) {
                console.error('Erreur affichage:', error);
            }
        };

        // ===== √âDITER LE PROFIL =====
        window.editProfile = function() {
            document.getElementById('editName').value = document.getElementById('profileName').textContent;
            document.getElementById('editPhone').value = document.getElementById('profilePhone').textContent;
            document.getElementById('editProfileModal').style.display = 'flex';
        };

        window.closeEditModal = function() {
            document.getElementById('editProfileModal').style.display = 'none';
        };

        // ===== SAUVEGARDER LE PROFIL =====
        window.saveProfile = async function(event) {
            event.preventDefault();

            const user = auth.currentUser;
            if (!user) return;

            const name = document.getElementById('editName').value;
            const phone = document.getElementById('editPhone').value;

            try {
                await db.collection('users').doc(user.uid).update({
                    displayName: name,
                    phone: phone,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert('‚úÖ Profil mis √† jour');
                closeEditModal();
                loadAccountData();

            } catch (error) {
                console.error('Erreur mise √† jour:', error);
                alert('‚ùå Erreur lors de la mise √† jour');
            }
        };

        // ===== CHARGEMENT INITIAL =====
        auth.onAuthStateChanged((user) => {
            if (user) {
                loadAccountData();
            } else {
                window.location.href = '/?needLogin=true';
            }
        });

        // ===== FERMER LE MODAL EN CLIQUANT √Ä L'EXT√âRIEUR =====
        window.onclick = function(event) {
            const modal = document.getElementById('editProfileModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        };
    </script>
</body>
</html>
