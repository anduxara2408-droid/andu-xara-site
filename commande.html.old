<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finaliser la Commande - Andu Xara</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
            color: white;
        }

        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .commande-section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 2rem;
        }

        .section-title {
            color: #4a5568;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .produit-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .produit-info {
            flex: 1;
        }

        .produit-nom {
            font-weight: bold;
            color: #2d3748;
        }

        .produit-details {
            color: #718096;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .produit-prix {
            font-weight: bold;
            color: #2d3748;
            text-align: right;
        }

        .prix-original {
            text-decoration: line-through;
            color: #a0aec0;
            font-size: 0.9rem;
        }

        .prix-reduit {
            color: #27ae60;
            font-size: 1.1rem;
        }

        .reduction-badge {
            background: #27ae60;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-left: 8px;
        }

        .total-section {
            background: #f7fafc;
            border-radius: 10px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            text-align: center;
        }

        .montant-total {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .economie {
            color: #27ae60;
            font-weight: bold;
        }

        .info-client {
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .info-client h4 {
            color: #2d7d32;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .paiement-options {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-top: 1.5rem;
        }

        .paiement-option {
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .paiement-option:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .paiement-option.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .paiement-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #667eea;
        }

        .paiement-nom {
            font-weight: bold;
            color: #4a5568;
            margin-bottom: 5px;
        }

        .paiement-details {
            color: #718096;
            font-size: 0.9rem;
        }

        .btn-confirmer {
            width: 100%;
            padding: 16px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-confirmer:hover {
            background: #38a169;
            transform: translateY(-2px);
        }

        .btn-confirmer:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
            color: #667eea;
        }

        .loading i {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .confirmation {
            display: none;
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            border-radius: 10px;
            padding: 2rem;
            margin-top: 2rem;
            text-align: center;
        }

        .confirmation-icon {
            font-size: 3rem;
            color: #27ae60;
            margin-bottom: 1rem;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 10000;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            max-width: 300px;
            text-align: center;
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        .notification.error {
            background: #e53e3e;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .commande-section {
                padding: 1.5rem;
            }
            
            .paiement-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- En-t√™te -->
        <div class="header">
            <h1><i class="fas fa-shopping-bag"></i> Finaliser la Commande</h1>
            <p style="color: rgba(255,255,255,0.9);">V√©rifiez et confirmez votre commande</p>
        </div>

        <!-- Section Commande -->
        <div class="commande-section">
            <h2 class="section-title"><i class="fas fa-receipt"></i> R√©capitulatif de la Commande</h2>
            
            <!-- Informations Client -->
            <div class="info-client">
                <h4><i class="fas fa-user"></i> Informations Client</h4>
                <div id="clientInfo">
                    Chargement...
                </div>
            </div>

            <!-- Produits -->
            <div id="produitsListe">
                <!-- Rempli dynamiquement -->
            </div>

            <!-- Total -->
            <div class="total-section">
                <div id="totalDetails">
                    <!-- Rempli dynamiquement -->
                </div>
            </div>

            <!-- M√©thodes de Paiement -->
            <h2 class="section-title"><i class="fas fa-credit-card"></i> M√©thode de Paiement</h2>
            
            <div class="paiement-options">
                <div class="paiement-option" onclick="selectPaiement('wave')">
                    <div class="paiement-icon">
                        <i class="fas fa-mobile-alt"></i>
                    </div>
                    <div class="paiement-nom">Wave S√©n√©gal</div>
                    <div class="paiement-details">Paiement mobile s√©curis√©</div>
                </div>

                <div class="paiement-option" onclick="selectPaiement('bankily')">
                    <div class="paiement-icon">
                        <i class="fas fa-university"></i>
                    </div>
                    <div class="paiement-nom">Bankily Mauritanie</div>
                    <div class="paiement-details">Transfert bancaire</div>
                </div>

                <div class="paiement-option" onclick="selectPaiement('whatsapp')">
                    <div class="paiement-icon">
                        <i class="fab fa-whatsapp"></i>
                    </div>
                    <div class="paiement-nom">WhatsApp</div>
                    <div class="paiement-details">Discuter avec notre √©quipe</div>
                </div>
            </div>

            <!-- Bouton Confirmer -->
            <button class="btn-confirmer" onclick="confirmerCommande()" id="btnConfirmer">
                <i class="fas fa-check"></i> Confirmer la Commande
            </button>

            <!-- Loading -->
            <div class="loading" id="loading">
                <i class="fas fa-spinner"></i> Traitement en cours...
            </div>

            <!-- Confirmation -->
            <div class="confirmation" id="confirmation">
                <div class="confirmation-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h3>üéâ Commande Confirm√©e !</h3>
                <div id="confirmationDetails">
                    <!-- Rempli dynamiquement -->
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <script>
        // ===== CONFIGURATION FIREBASE =====
        const firebaseConfig = {
            apiKey: "AIzaSyC-OHtqpgOZI9AIb_WotYbiUS2L-Ac5vII",
            authDomain: "andu-xara-promo-codes-ff69e.firebaseapp.com",
            projectId: "andu-xara-promo-codes-ff69e",
            storageBucket: "andu-xara-promo-codes-ff69e.firebasestorage.app",
            messagingSenderId: "653516716143",
            appId: "1:653516716143:web:08ee1425191b4a1766359a"
        };

        // Initialiser Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        // ===== VARIABLES GLOBALES =====
        let panier = [];
        let user = null;
        let selectedPaiement = null;
        let promoData = null;

        // ===== FONCTIONS =====
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.innerHTML = message;
            notification.className = type === 'success' ? 'notification' : 'notification error';
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }

        function selectPaiement(methode) {
            selectedPaiement = methode;
            
            // Mettre √† jour l'interface
            document.querySelectorAll('.paiement-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            event.currentTarget.classList.add('selected');
            
            // Activer le bouton de confirmation
            document.getElementById('btnConfirmer').disabled = false;
        }

        function formatPrix(prix) {
            return new Intl.NumberFormat('fr-FR').format(prix);
        }

        function calculerTotaux() {
            let totalOriginal = 0;
            let totalReduit = 0;
            let discount = 0;
            let codePromo = '';

            // V√©rifier la r√©duction active
            const promoDataStr = localStorage.getItem('anduxara_active_promo');
            if (promoDataStr) {
                try {
                    promoData = JSON.parse(promoDataStr);
                    discount = promoData.discount;
                    codePromo = promoData.code;
                } catch (error) {
                    console.error('Erreur parsing promo data:', error);
                }
            }

            panier.forEach(produit => {
                const prixOriginal = produit.prixOriginal || produit.prix;
                const prixReduit = produit.prixReduit || produit.prix;
                
                totalOriginal += prixOriginal * produit.quantite;
                totalReduit += prixReduit * produit.quantite;
            });

            return {
                totalOriginal,
                totalReduit,
                discount,
                codePromo,
                economie: totalOriginal - totalReduit
            };
        }

        function afficherProduits() {
            const container = document.getElementById('produitsListe');
            const totaux = calculerTotaux();

            let html = '';
            
            panier.forEach(produit => {
                const prixOriginal = produit.prixOriginal || produit.prix;
                const prixActuel = produit.prixReduit || produit.prix;
                const hasReduction = prixActuel < prixOriginal;

                html += `
                    <div class="produit-item">
                        <div class="produit-info">
                            <div class="produit-nom">${produit.nom}</div>
                            <div class="produit-details">Quantit√©: ${produit.quantite} ‚Ä¢ Taille: ${produit.taille || 'Unique'}</div>
                        </div>
                        <div class="produit-prix">
                            ${hasReduction ? `
                                <div class="prix-original">${formatPrix(prixOriginal)} MRU</div>
                            ` : ''}
                            <div class="prix-reduit">
                                ${formatPrix(prixActuel)} MRU
                                ${hasReduction ? `<span class="reduction-badge">-${totaux.discount}%</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function afficherTotal() {
            const container = document.getElementById('totalDetails');
            const totaux = calculerTotaux();

            let html = '';
            
            if (totaux.totalReduit < totaux.totalOriginal) {
                html = `
                    <div style="text-decoration: line-through; color: #718096; font-size: 1.1rem;">
                        ${formatPrix(totaux.totalOriginal)} MRU
                    </div>
                    <div class="montant-total">
                        ${formatPrix(totaux.totalReduit)} MRU
                    </div>
                    <div class="economie">
                        √âconomie: ${formatPrix(totaux.economie)} MRU
                        ${totaux.codePromo ? `‚Ä¢ Code: ${totaux.codePromo}` : ''}
                    </div>
                `;
            } else {
                html = `
                    <div class="montant-total">
                        ${formatPrix(totaux.totalReduit)} MRU
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function afficherInfosClient() {
            const container = document.getElementById('clientInfo');
            
            if (user) {
                container.innerHTML = `
                    <div><strong>Nom:</strong> ${user.displayName || 'Non sp√©cifi√©'}</div>
                    <div><strong>Email:</strong> ${user.email}</div>
                    <div><strong>ID:</strong> ${user.uid.substring(0, 8)}...</div>
                `;
            } else {
                container.innerHTML = '<div style="color: #e53e3e;">‚ùå Utilisateur non connect√©</div>';
            }
        }

        async function enregistrerCommandeFirebase(commandeData) {
            try {
                const commandeComplete = {
                    ...commandeData,
                    userId: user.uid,
                    userEmail: user.email,
                    userName: user.displayName || 'Client',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'en_attente',
                    numeroCommande: 'CMD-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5).toUpperCase()
                };

                const docRef = await firebase.firestore().collection('commandes').add(commandeComplete);
                console.log('‚úÖ Commande enregistr√©e dans Firebase:', docRef.id);
                return commandeComplete.numeroCommande;
            } catch (error) {
                console.error('‚ùå Erreur enregistrement commande Firebase:', error);
                return null;
            }
        }

        async function marquerCodeUtilise(userId, code) {
            try {
                const usageQuery = await firebase.firestore()
                    .collection('promoUsage')
                    .where('userId', '==', userId)
                    .where('promoCode', '==', code)
                    .where('status', '==', 'applied')
                    .get();

                if (!usageQuery.empty) {
                    const usageId = usageQuery.docs[0].id;
                    await firebase.firestore().collection('promoUsage').doc(usageId).update({
                        status: 'used',
                        usedInOrder: true,
                        orderCompletedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log('‚úÖ Code marqu√© comme utilis√©:', code);
                }
            } catch (error) {
                console.error('‚ùå Erreur marquage code utilis√©:', error);
            }
        }

        async function confirmerCommande() {
            if (!selectedPaiement) {
                showNotification('‚ùå Veuillez s√©lectionner une m√©thode de paiement', 'error');
                return;
            }

            if (!user) {
                showNotification('‚ùå Vous devez √™tre connect√© pour commander', 'error');
                return;
            }

            if (panier.length === 0) {
                showNotification('‚ùå Votre panier est vide', 'error');
                return;
            }

            try {
                // Afficher le loading
                document.getElementById('loading').style.display = 'block';
                document.getElementById('btnConfirmer').disabled = true;

                const totaux = calculerTotaux();
                const numeroCommande = await enregistrerCommandeFirebase({
                    produits: panier,
                    total: totaux.totalReduit,
                    totalOriginal: totaux.totalOriginal,
                    economie: totaux.economie,
                    methodePaiement: selectedPaiement,
                    codePromo: totaux.codePromo,
                    discount: totaux.discount,
                    statut: 'confirm√©e'
                });

                // Marquer le code promo comme utilis√©
                if (totaux.codePromo) {
                    await marquerCodeUtilise(user.uid, totaux.codePromo);
                }

                // Vider le panier
                localStorage.removeItem('panier');
                localStorage.removeItem('anduxara_active_promo');
                localStorage.removeItem('anduxara_cart_promo');

                // Afficher la confirmation
                afficherConfirmation(numeroCommande, totaux);
                
                showNotification('‚úÖ Commande confirm√©e avec succ√®s !');

            } catch (error) {
                console.error('‚ùå Erreur confirmation commande:', error);
                showNotification('‚ùå Erreur lors de la confirmation de la commande', 'error');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function afficherConfirmation(numeroCommande, totaux) {
            const container = document.getElementById('confirmation');
            const details = document.getElementById('confirmationDetails');

            const methodesNoms = {
                'wave': 'Wave S√©n√©gal',
                'bankily': 'Bankily Mauritanie', 
                'whatsapp': 'WhatsApp'
            };

            let html = `
                <p><strong>‚úÖ Votre commande a √©t√© enregistr√©e</strong></p>
                <p><strong>üì¶ Num√©ro de commande:</strong> ${numeroCommande || 'N/A'}</p>
                <p><strong>üí≥ M√©thode:</strong> ${methodesNoms[selectedPaiement]}</p>
                <p><strong>üí∞ Montant:</strong> ${formatPrix(totaux.totalReduit)} MRU</p>
                ${totaux.codePromo ? `<p><strong>üéÅ Code promo:</strong> ${totaux.codePromo} (-${totaux.discount}%)</p>` : ''}
                ${totaux.economie > 0 ? `<p><strong>üí∏ √âconomie:</strong> ${formatPrix(totaux.economie)} MRU</p>` : ''}
                
                <div style="margin-top: 1.5rem; padding: 1rem; background: #e6fffa; border-radius: 8px;">
                    <p><strong>üìû Prochaines √©tapes:</strong></p>
                    <p>1. Notre √©quipe va vous contacter sous 24h</p>
                    <p>2. Confirmation finale de la commande</p>
                    <p>3. Livraison selon votre zone</p>
                </div>
                
                <div style="margin-top: 1rem; font-size: 0.9rem; color: #666;">
                    <p><strong>üìû Contact:</strong> +222 49 03 76 97</p>
                </div>
            `;

            details.innerHTML = html;
            container.style.display = 'block';

            // Faire d√©filer vers la confirmation
            container.scrollIntoView({ behavior: 'smooth' });
        }

        // ===== INITIALISATION =====
        document.addEventListener('DOMContentLoaded', function() {
            // V√©rifier l'authentification
            firebase.auth().onAuthStateChanged((userData) => {
                if (userData) {
                    user = userData;
                    afficherInfosClient();
                    
                    // Charger le panier
                    panier = JSON.parse(localStorage.getItem('panier')) || [];
                    
                    if (panier.length === 0) {
                        showNotification('‚ùå Votre panier est vide', 'error');
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 2000);
                        return;
                    }

                    afficherProduits();
                    afficherTotal();
                    
                } else {
                    showNotification('‚ùå Connectez-vous pour commander', 'error');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                }
            });
        });

        // Exposer les fonctions globalement
        window.selectPaiement = selectPaiement;
        window.confirmerCommande = confirmerCommande;
    </script>
</body>
</html>
