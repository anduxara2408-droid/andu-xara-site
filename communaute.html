<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Communauté Andu-Xara</title>
<style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f4f4; margin:0; padding:20px;}
    h1 { text-align:center; color:#667eea; font-size: 1.8rem; }
    .post-form { background:white; padding:15px; border-radius:12px; margin-bottom:20px; box-shadow:0 5px 15px rgba(0,0,0,0.1);}
    input, textarea { width:100%; padding:10px; margin:5px 0; border-radius:6px; border:1px solid #ccc; font-size:1rem;}
    button { padding:10px 20px; background:#667eea; color:white; border:none; border-radius:6px; cursor:pointer; font-size:1rem; }
    .posts-container { display:flex; flex-direction:column; gap:20px; }
    .post-card { background:white; padding:15px; border-radius:12px; box-shadow:0 5px 15px rgba(0,0,0,0.1);}
    .post-card img { max-width:100%; border-radius:8px; margin-top:10px;}
    .post-card h3 { margin:0 0 5px 0; color:#333; font-size:1.1rem; }
    .post-card p { margin:0; font-size:0.95rem; }
    .post-card small { color:#666; font-size:0.8rem; }
    @media (max-width:600px) {
        body { padding:10px; }
        .post-form, .post-card { padding:10px; }
        h1 { font-size:1.5rem; }
        input, textarea, button { font-size:0.95rem; }
    }
</style>
</head>
<body>

<h1>Communauté Andu-Xara</h1>

<div class="post-form">
    <h2>Publier une photo ou un commentaire</h2>
    <input type="text" id="username" placeholder="Votre nom">
    <textarea id="comment" rows="2" placeholder="Votre commentaire"></textarea>
    <input type="file" id="imageFile" accept="image/*"> 
    <button onclick="publishPost()">Publier</button>
</div>

<div class="posts-container" id="postsContainer"></div>

<script>
// Ton URL Apps Script (version déployée)
const scriptURL = "https://script.google.com/macros/s/AKfycbwFJpNs-QJ1OXTe2AUgLecctsbYMFe6TnOM2NtvdHVR/dev";

// Publier une nouvelle publication
async function publishPost() {
    const username = document.getElementById('username').value.trim();
    const comment = document.getElementById('comment').value.trim();
    const imageFile = document.getElementById('imageFile').files[0];

    if (!username || !comment) {
        alert("Veuillez entrer votre nom et un commentaire.");
        return;
    }

    let imageData = "";
    if (imageFile) {
        imageData = await new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = e => resolve(e.target.result);
            reader.readAsDataURL(imageFile);
        });
    }  

    const formData = new FormData();
    formData.append("nom", username);
    formData.append("commentaire", comment);
    formData.append("image", imageData);

    fetch(scriptURL, { method: "POST", body: formData })
        .then(response => response.json())
        .then(data => {
            if(data.result === "success") {
                alert("✅ Publication réussie !");
                document.getElementById('username').value = "";
                document.getElementById('comment').value = "";
                document.getElementById('imageFile').value = "";
                loadPosts(); // Recharge les posts
            } else {
                alert("❌ Erreur : " + data.message);
            }
        })
        .catch(err => alert("❌ Erreur réseau : " + err));
}

// Récupérer toutes les publications
function loadPosts() {
    fetch(scriptURL)
        .then(response => response.json())
        .then(data => {
            const posts = data.posts || [];
            const container = document.getElementById('postsContainer'); 
            container.innerHTML = "";
            posts.reverse().forEach(post => {
                const card = document.createElement('div');
                card.className = "post-card";
                let imgHtml = post.image ? <img src="${post.image}" alt="Photo de ${post.nom}"> : "";
                card.innerHTML = `<h3>${post.nom}</h3>
                                  <p>${post.commentaire}</p>
                                  ${imgHtml}
                                  <small>Publié le : ${new Date(post.date).toLocaleString()}</small>`;
                container.appendChild(card);
            });
        })
        .catch(err => console.error("Erreur récupération posts :", err));
}

// Charger les publications au démarrage
window.onload = loadPosts;
</script>

</body>
</html>
