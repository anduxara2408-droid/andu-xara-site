// ===== UTILITAIRES CODES PROMO - FONCTIONS PARTAG√âES =====

/**
 * Marque un code promo comme utilis√© apr√®s une commande
 */
async function marquerCodeUtilise(userId, code) {
    try {
        console.log('üîÑ Marquage code comme utilis√©:', code, 'pour user:', userId);
        
        const usageQuery = await firebase.firestore()
            .collection('promoUsage')
            .where('userId', '==', userId)
            .where('promoCode', '==', code)
            .where('status', '==', 'applied')
            .get();

        if (!usageQuery.empty) {
            const usageId = usageQuery.docs[0].id;
            await firebase.firestore().collection('promoUsage').doc(usageId).update({
                status: 'used',
                usedInOrder: true,
                orderCompletedAt: firebase.firestore.FieldValue.serverTimestamp(),
                orderCompleted: true
            });
            
            console.log('‚úÖ Code marqu√© comme utilis√© avec succ√®s:', code);
            return true;
        } else {
            console.log('‚ö†Ô∏è Aucun usage trouv√© √† marquer comme utilis√©');
            return false;
        }
    } catch (error) {
        console.error('‚ùå Erreur marquage code utilis√©:', error);
        return false;
    }
}

/**
 * V√©rifie si un utilisateur a un code promo actif
 */
async function verifierCodeActifUtilisateur(userId) {
    try {
        const activeUsageQuery = await firebase.firestore()
            .collection('promoUsage')
            .where('userId', '==', userId)
            .where('status', '==', 'applied')
            .orderBy('usedAt', 'desc')
            .limit(1)
            .get();

        if (!activeUsageQuery.empty) {
            const lastUsage = activeUsageQuery.docs[0].data();
            const usageDate = lastUsage.usedAt?.toDate();
            const now = new Date();
            const diffHours = (now - usageDate) / (1000 * 60 * 60);

            // Code valide si utilis√© dans les 24h
            if (diffHours < 24) {
                return {
                    code: lastUsage.promoCode,
                    discount: lastUsage.discount,
                    description: lastUsage.description,
                    usedAt: usageDate,
                    persistent: true
                };
            }
        }
        return null;
    } catch (error) {
        console.error('Erreur v√©rification code actif:', error);
        return null;
    }
}

/**
 * R√©cup√®re l'historique des codes utilis√©s par un utilisateur
 */
async function getHistoriqueCodesUtilisateur(userId) {
    try {
        const historyQuery = await firebase.firestore()
            .collection('promoUsage')
            .where('userId', '==', userId)
            .orderBy('usedAt', 'desc')
            .limit(10)
            .get();

        return historyQuery.docs.map(doc => {
            const data = doc.data();
            return {
                ...data,
                usedAt: data.usedAt?.toDate()
            };
        });
    } catch (error) {
        console.error('Erreur r√©cup√©ration historique:', error);
        return [];
    }
}

// Exposer les fonctions globalement
window.marquerCodeUtilise = marquerCodeUtilise;
window.verifierCodeActifUtilisateur = verifierCodeActifUtilisateur;
window.getHistoriqueCodesUtilisateur = getHistoriqueCodesUtilisateur;
